<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- ... (toute la partie <head> et <style> reste inchang√©e) ... -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TCHATCHI AI Pedagogical Assistant</title>
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PVE22CBKK7"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PVE22CBKK7');
    </script>
    <style>
        :root {
            --sidebar-bg: #f8f9fa; --chat-background: #ffffff; --main-bg: #f8f9fa; --input-bg: #f8f9fa;
            --user-bubble-bg: #e7f1ff; --user-bubble-text: #001d35; --ai-bubble-bg: #f1f3f4;
            --ai-bubble-text: #202124; --text-color-primary: #1f1f1f; --text-color-secondary: #444746;
            --border-color: #dee2e6;
        }
        html, body { 
            height: 100%; 
            max-height: 100%; /* Emp√™che le body de d√©passer la taille de l'√©cran */
            overflow: hidden; /* Pas de scroll sur la page principale */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            max-width: 100%;
            overflow-x: hidden;
        }

        body { 
            display: flex; 
            background-color: var(--main-bg); 
        }
        
        #sidebar { width: 280px; background-color: var(--sidebar-bg); padding: 1rem; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        #sidebar .btn-new-chat { background-color: #d3e3fd; color: #0b57d0; border: none; font-weight: 500;}
        #sidebar h5 { color: var(--text-color-secondary); margin-top: 1.5rem; font-size: 0.9rem; text-transform: uppercase; font-weight: 600; }
        #sidebar .history-list { flex-grow: 1; overflow-y: auto; }
        #sidebar .history-item { color: var(--text-color-secondary); text-decoration: none; padding: 0.5rem; display: block; border-radius: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #sidebar .history-item:hover { background-color: #e0e6ef; }
        #sidebar .ia-disclaimer { font-size: 0.75rem; color: var(--text-color-secondary); margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem; }

        #main-container { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; /* Utilise la hauteur compl√®te de la fen√™tre */
            max-height: 100vh; /* Emp√™che le conteneur de grandir au-del√† */
            max-width: 100vw; 
            overflow: hidden;
        }
        /* --- 1. L'en-t√™te principal --- */
                #main-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--main-bg);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: nowrap;
            /* NOUVELLE TRANSITION, PLUS PERFORMANTE */
            transition: transform 0.3s ease-in-out;
        }

                #main-header.header-hidden {
            /* Au lieu de changer la hauteur, on d√©place la barre vers le haut */
            transform: translateY(-100%);
            /* En passant la position √† 'absolute', on retire l'en-t√™te du flux
               de la page. La zone de chat en dessous va alors automatiquement
               monter et occuper l'espace lib√©r√©, cr√©ant l'effet plein √©cran. */
            position: absolute;
        }

       /* --- 2. Le conteneur du logo et du titre --- */
        .app-title-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1; /* Permet au conteneur de grandir/r√©tr√©cir */
            min-width: 0; /* Astuce cruciale pour permettre au texte de se r√©duire */
        }

        /* --- 3. Le titre de l'application (pour √©viter qu'il ne d√©borde) --- */
        .app-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color-primary);
            /* Emp√™che le titre de d√©border et de pousser le menu */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #main-header .app-icon { font-size: 1.5rem; color: #0b57d0; }
        #main-header .app-title { font-size: 1.1rem; font-weight: 500; color: var(--text-color-primary); }
/* NOUVELLE VERSION CORRIG√âE */
#chat-container {
    flex-grow: 1; /* Prend l'espace vertical disponible */
    display: flex;
    flex-direction: column;
    background-color: var(--chat-background);
    /* TR√àS IMPORTANT : On retire la hauteur fixe et on laisse flexbox g√©rer */
    overflow-y: hidden; /* Le conteneur ne scroll pas, c'est son enfant qui le fera */
    position: relative; /* N√©cessaire pour que le scroll interne fonctionne bien */
}

#chat-messages {
    flex-grow: 1; /* Prend l'espace disponible √† l'int√©rieur de #chat-container */
    padding: 1rem;
    overflow-y: auto; /* C'est LUI qui scroll, et personne d'autre */
    -webkit-overflow-scrolling: touch; /* Am√©liore le scroll sur iOS */
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
        .message { display: flex; margin-bottom: 0.5rem; }
        .message .content { padding: 0.5rem 1rem; border-radius: 8px; max-width: 80%; width: fit-content; line-height: 1.5; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message.ai { justify-content: flex-start; }
        .message.ai .content { background-color: var(--ai-bubble-bg); color: var(--ai-bubble-text); border-radius: 0 8px 8px 8px; }
        .message.ai .content::before { content: ''; position: absolute; top: 0; left: -10px; width: 0; height: 0; border-style: solid; border-width: 0 10px 10px 0; border-color: transparent var(--ai-bubble-bg) transparent transparent; }
        .message.user { justify-content: flex-end; }
        .message.user .content { background-color: var(--user-bubble-bg); color: var(--user-bubble-text); border-radius: 8px 0 8px 8px; }
        .message.user .content::after { content: ''; position: absolute; top: 0; right: -10px; width: 0; height: 0; border-style: solid; border-width: 0 0 10px 10px; border-color: transparent transparent transparent var(--user-bubble-bg); }
        #chat-input-area { padding: 1rem 1.5rem; background-color: var(--main-bg); border-top: 1px solid var(--border-color); position: sticky; bottom: 0; /* Add safe area for mobile notches */padding-bottom: calc(1rem + env(safe-area-inset-bottom)); z-index: 20;}
        #chat-input-area-content { max-width: 800px; margin: 0 auto; width: 100%; }
        /* NOUVEAU BLOC CORRIG√â */

        #options-container {
            padding: 0 0 1rem 0;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            /* --- AJOUTS IMPORTANTS --- */
            max-height: 250px; /* On limite la hauteur √† 250px (environ 4-5 lignes de boutons) */
            overflow-y: auto;  /* Affiche une barre de d√©filement verticale si le contenu d√©passe */
            padding-right: 8px; /* Ajoute un petit espace pour que la barre de d√©filement ne colle pas aux boutons */
        }
        .option-button { border: 1px solid #c9c9c9; background-color: #fff; color: #3c4043; font-weight: 500; }
        .option-button:hover { background-color: #f1f1f1; }
        #chat-form .input-group { background-color: #ffffff; border-radius: 25px; padding: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        #chat-input { background-color: transparent; border: none; box-shadow: none; }
        #chat-submit-btn { background-color: transparent; border: none; color: #5f6368; font-size: 1.5rem; }
        #main-footer { text-align: center; font-size: 0.8rem; color: #999; padding: 0.5rem; background-color: var(--main-bg); border-top: 1px solid var(--border-color);  position: relative; z-index: 10;}
        

        /*
        
        ==================================================
        STYLE POUR LE SPINNER DE CHARGEMENT
        ==================================================
        */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1); /* Bordure grise l√©g√®re */
            border-top-color: #0d6efd; /* Couleur bleue pour la partie qui tourne */
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite; /* Fait tourner l'animation */
        }

        /* L'animation de rotation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Conteneur pour aligner le spinner et le texte */
        .loading-content {
            display: flex;
            align-items: center;
            gap: 10px; /* Espace entre le spinner et le texte */
        }
        /* style pour la langue de la home page*/

        .lang-selector {
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            background-color: #e9ecef;
            border-radius: 25px;
            display: flex; /* Pour aligner les boutons de langue */
            align-items: center;
        }
        
        .lang-selector .lang-btn {
            text-decoration: none;
            color: #6c757d;
            padding: 0.2rem 0.4rem;
            border-radius: 20px;
        }

        .lang-selector .lang-btn.active {
            color: var(--primary-color);
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap; /* Allow buttons to wrap */
            justify-content: flex-end; /* Align to right */
        }


    /* ==================================================
       STYLE POUR L'INDICATEUR DE FRAPPE (PROGRESSION)
    ================================================== */
    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 10px 15px !important; /* S'assure que le padding est correct */
    }

    /* Style pour chaque point de l'animation */
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #999; /* Couleur grise pour les points */
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        /* On lie chaque point √† l'animation */
        animation: bounce 1.4s infinite ease-in-out both;
    }

    /* On ajoute un l√©ger d√©calage √† chaque point pour un effet fluide */
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0s; }

    /* L'animation elle-m√™me qui fait "rebondir" les points */
    @keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1.0);
        }
    }  
    
    /* ==================================================
   STYLE POUR LA FEN√äTRE MODALE D'INFORMATION
================================================== */
#welcomeModal .modal-header {
    background-color: var(--primary-color);
    color: white;
}
#welcomeModal .modal-header .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}
#welcomeModal .modal-title {
    font-weight: 600;
}
#welcomeModal h4, #welcomeModal h6 {
    color: var(--primary-color);
    font-weight: bold;
}
#welcomeModal code {
    background-color: #e9ecef;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    color: #d63384;
    font-weight: bold;
    display: inline-block;
    margin: 5px 0;
}
#welcomeModal .donation-methods {
    padding-left: 1rem;
    border-left: 3px solid #dee2e6;
}


    /* ===========================
       RESPONSIVE DESIGN
    ============================ */
    /* Mobile menu toggle */
#menu-toggle {
    display: none;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
}

/* --- 4. Le bouton Burger Menu (sur mobile) --- */

    @media (max-width: 1200px) {
        #sidebar {
            width: 260px;
        }
        
        .message .content {
            max-width: 75%;
        }
    }
    
    @media (max-width: 992px) {
        #sidebar {
            width: 240px;
        }
        
        #main-header .app-title {
            font-size: 1.1rem;
        }
        
        .message .content {
            max-width: 80%;
            padding: 0.75rem 1rem;
        }
    }
/* NOUVEAU BLOC UNIFI√â √Ä AJOUTER */

    @media (max-width: 768px) {
        /* --- Structure g√©n√©rale sur mobile --- */
        body {
            flex-direction: column;
            overflow: auto;
            height: auto;
        }
        
        #sidebar {
            width: 100%;
            height: auto;
            border-right: none;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem;
        }
        
        #main-container {
            height: auto;
            min-height: 100vh;
        }
        
        #main-header {
            padding: 0.5rem;
        }
        
        .message .content {
            max-width: 85%;
        }
        
        #chat-input-area {
            padding: 0.75rem;
        }
        
        #options-container {
            padding-bottom: 0.75rem;
        }
        
        .option-button {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        /* --- Bouton Burger (Menu Hamburger) --- */
        #menu-toggle {
            display: flex; /* S'assure qu'il est visible sur mobile */
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            flex-shrink: 0;
            margin-left: auto; /* Le pousse tout √† droite */
        }

        /* --- Styles pour le menu lat√©ral (mobile) --- */
        .nav-menu {
            position: fixed;
            top: 60px;
            right: -100%; /* Cach√© par d√©faut en dehors de l'√©cran */
            width: 220px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            flex-direction: column; /* Aligne les boutons verticalement */
            align-items: stretch;
            gap: 0.5rem;
            z-index: 1000;
            transition: right 0.3s ease-in-out;
            border: 1px solid var(--border-color);
        }
        
        .nav-menu.show {
            right: 1rem; /* Fait appara√Ætre le menu */
        }

        .nav-menu .btn {
            width: 100%;
            text-align: left;
        }

        .lang-selector {
        order: -1; /* Place le s√©lecteur de langue en haut du menu mobile */
        margin-bottom: 0.5rem; /* Ajoute un peu d'espace en dessous */
        }
    }

    @media (max-width: 576px) {
        #sidebar {
            position: fixed;
            z-index: 1000;
            height: 100%;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            padding: 0.5rem;
        }
        
        #sidebar.show {
            transform: translateX(0);
        }
        
        #main-container {
            margin-left: 0;
        }
        
        #menu-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--main-bg);
            border: 1px solid var(--border-color);
            margin-right: 0.5rem;
        }
        
        #chat-messages {
            padding: 1rem 0.75rem;
        }
        
        .message .content {
            max-width: 90%;
            padding: 0.6rem 0.9rem;
            font-size: 0.95rem;
        }
        
        #chat-input-area {
            padding: 0.75rem 0.75rem calc(0.75rem + env(safe-area-inset-bottom));
        }
        
        #chat-form .input-group {
            padding: 0.25rem;
            border-radius: 20px;
        }
        
        #chat-input {
            font-size: 0.95rem;
            padding: 0.5rem 0.75rem;
        }
        
        #chat-submit-btn {
            font-size: 1.25rem;
            padding: 0 0.75rem;
        }
        
        .option-button {
            font-size: 0.85rem;
            padding: 0.35rem 0.7rem;
            margin: 0.15rem;
        }
    }
    
    @media (max-width: 480px) {
        #main-header {
            flex-direction: column;
            align-items: flex-start;
            padding: 0.5rem 1rem;
        }
        #main-header .app-title {
            font-size: 0.9rem;
        }
        #chat-input-area {
            padding: 0.5rem 1rem;
        }
        #chat-input-area-content {
            max-width: 100%;
        }
        #options-container {
            flex-direction: column;
            gap: 0.25rem;
        }
        .option-button {
            width: 100%;
            text-align: center;
        }
    }
    .app-icon {
        width: 60px;  /* Correspond √† la taille de police de 1.5rem */
        height: 60px; /* Maintient le ratio carr√© */
        object-fit: contain; /* S'assure que l'image s'adapte sans √™tre d√©form√©e */
    }
    </style>
      
</head>
<body>

    <!-- ... (tout le HTML de la sidebar et du main-container reste inchang√©) ... -->
   <div id="sidebar">
    <!-- On utilise onclick pour appeler la fonction JS globale -->
    <button class="btn btn-new-chat w-100 text-start mb-3" onclick="startNewChat()">
        <i class="bi bi-plus-lg me-2"></i>
        <!-- On ajoute un <span> pour la traduction -->
        <span data-lang-en="New Chat" data-lang-fr="Nouveau Chat">New Chat</span>
    </button>
    
    <div class="history-list">
        <!-- Le titre est maintenant traduisible -->
        <h5 data-lang-en="History" data-lang-fr="Historique">History</h5>
        
        <!-- Ce conteneur sera rempli dynamiquement par la fonction loadHistory() -->
        <ul class="list-unstyled" id="history-items-container">
            <!-- La liste est vide au d√©but -->
        </ul>
    </div>
    
    <div class="ia-disclaimer" data-lang-en="AI models can make mistakes. Please check important information." data-lang-fr="Les mod√®les d'IA peuvent faire des erreurs. Veuillez v√©rifier les informations importantes.">
        AI models can make mistakes. Please check important information.
    </div>
</div>

    <div id="main-container">

    <!-- ======================================================================= -->
    <!-- NOUVEL EN-T√äTE DYNAMIQUE -->
    <!-- ======================================================================= -->
    <div id="main-header">
        <button id="menu-toggle" class="d-lg-none btn btn-sm btn-light">
            <i class="bi bi-list"></i>
        </button>
        <div class="app-title-container">
            <img src="/static/img/favicon.png" alt="TCHATCHI AI Logo" class="app-icon"> 
            <span id="app-title" class="app-title">TCHATCHI AI <br>Pedagogical Assistant</span>
        </div>
        
        <!-- Ce menu s'affichera pour l'utilisateur connect√© -->
        <div class="nav-menu">
              
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle me-2"></i>
                    <!-- On affiche le nom de l'utilisateur ici -->
                    {{ user.full_name }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li></li><a href="/about" class="dropdown-item"  data-lang-en="About" data-lang-fr="√Ä Propos">About</a></li>
                    <li></li><a href="/donate" class="dropdown-item" ><i class="bi bi-heart"></i> <span data-lang-en="Donate" data-lang-fr="Soutenir projet">Donate</span></a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/logout">
                        <i class="bi bi-box-arrow-right me-2"></i> Se D√©connecter
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
    <!-- ======================================================================= -->
    <!-- FIN DU NOUVEL EN-T√äTE -->
    <!-- ======================================================================= -->
        <div id="chat-container">
            <div id="chat-messages">
                <div class="message ai">
                    <div class="content">Hello! I am the TCHATCHI AI pedagogical assistant. </div>

                </div>
                <div class="message ai">
                    <div class="content">Please choose your language.</div>

                </div>
                 <div class="message ai">
                    <div class="content">Bonjour ! Je suis l'assistant p√©dagogique TCHATCHI AI.</div>
                </div>
                <div class="message ai">
                    <div class="content">Veuillez choisir votre langue.</div>
                </div>
            </div>
        </div>
        <div id="chat-input-area">
            <div id="chat-input-area-content">
                <div id="options-container">
                    <button class="btn option-button">üá¨üáß English</button>
                    <button class="btn option-button">üá´üá∑ Fran√ßais</button>
                </div>
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Make a choice or send a message..." autocomplete="off">
                        <button id="chat-submit-btn" type="submit" class="btn"><i class="bi bi-arrow-up-circle-fill"></i></button>
                    </div>
                </form>
            </div>
        </div>
        <footer id="main-footer">
           <p> ¬© 2025 TCHATCHI AI Project - All rights reserved.</p><br>
           <p>Powered by TKC@Co</p>
        </footer>
    </div>


<!-- ======================================================================= -->
<!-- D√âBUT DE LA FEN√äTRE MODALE D'INFORMATION -->
<!-- ======================================================================= -->
<div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="welcomeModalLabel">Bienvenue sur TCHATCHI AI !</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Version Fran√ßaise -->
                <div class="mb-4">
                    <h4>üá´üá∑ Bienvenu sur TCHATCHI AI! L‚ÄôIA au service des enseignants camerounais</h4>
                    <p>
                        <strong>TCHATCHI AI</strong> est une plateforme con√ßue pour accompagner les enseignants du Cameroun dans la pr√©paration de leurs contenus p√©dagogiques.
                    </p>
                    <p>
                        <strong>Fonctionnalit√©s :</strong> G√©n√©ration rapide de fiches de le√ßon, d‚Äôactivit√©s d‚Äôint√©gration et d‚Äô√©valuations conformes aux programmes francophone et anglophone.
                    </p>
                    <p>
                        <strong>Notre mission :</strong> Redonner du temps aux enseignants, am√©liorer la qualit√© de l‚Äôenseignement, et promouvoir une √©ducation √©quitable.
                    </p>
                    <hr>
                    <h6>üí° Projet personnel, sans financement externe</h6>
                    <p>
                        Chaque ressource g√©n√©r√©e co√ªte en moyenne <strong>15 FCFA</strong> en frais de calcul. Plus de <strong>19 000 ressources</strong> ont d√©j√† √©t√© g√©n√©r√©es, soit un co√ªt cumul√© d'environ <strong>285 000 FCFA</strong>, enti√®rement √† notre charge.
                    </p>
                    <p>Vu le taux de participations de la part des utilisateur qui √©tait presque nul par rapport aux d√©penses, nous avons du restructurer la plateforme pour une utilisation plus mod√©r√©e et avantageuse pour ceux qui participent</p>
                    <h6>üí∞ Comment contribuer / faire un don</h6>
                    <p>Chaque don, petit ou grand, aide √† couvrir les frais et √† assurer l'accessibilit√© de la plateforme.</p>
                    <div class="donation-methods">
                        <p><strong>‚úÖ MTN Mobile Money (MOMO)</strong><br>
                           <code>*126*14*680018753*MONTANT#</code><br>
                           <small>Nom du compte : SODIACAM SARL_POS 1208</small>
                        </p>
                        <p><strong>‚úÖ Orange Money (OM)</strong><br>
                           <code>#150*47*895595*MONTANT#</code><br>
                           <small>Nom du compte : Tala Kuate Cedric</small>
                        </p>
                    </div>
                    <p><em>Remplacez "MONTANT" par la somme de votre don.</em></p>
                    <hr>
                
                    
                </div>

                <!-- English Version -->
                <div class="pt-4 border-top">
                    <h4>üá¨üáß Welcome to TCHATCHI AI! Empowering Cameroonian Teachers with AI</h4>
                    <p>
                        <strong>TCHATCHI AI</strong> is a personal project with no external funding, built to help Cameroonian teachers create lesson plans and assessments aligned with local curricula.
                    </p>
                    <p>
                        Each resource generated costs about <strong>15 FCFA</strong> in AI processing fees. Over <strong>19,000 resources</strong> have been generate, meaning over <strong>285,000 FCFA</strong> have been invested so far, free for educators.
                    </p>
                    <p>Given the participation rate on the part of users which was almost zero compared to expenses, we had to restructure the platform for more moderate and advantageous use for those who participate</p>
                    <h6>üí∞ Donate via:</h6>
                     <div class="donation-methods">
                        <p><strong>‚úÖ MTN MOMO</strong><br>
                           <code>*126*14*680018753*AMOUNT#</code><br>
                           <small>Account Name: SODIACAM SARL_POS 1208</small>
                        </p>
                        <p><strong>‚úÖ Orange Money</strong><br>
                           <code>#150*47*895595*AMOUNT#</code><br>
                           <small>Account Name: Tala Kuate Cedric</small>
                        </p>
                    </div>
                    <p><em>Replace "AMOUNT" with your donation amount.</em></p>
                    <hr>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Compris / Understood</button>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================================= -->
<!-- FIN DE LA FEN√äTRE MODALE D'INFORMATION -->
<!-- ======================================================================= -->
<!-- ======================================================================= -->
<!-- D√âBUT DU BLOC DE SCRIPTS UNIQUE ET RESTRUCTUR√â -->
<!-- ======================================================================= -->

<!-- 1. Import des librairies externes -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- 2. Notre script principal d'application -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // =======================================================================
    // SECTION A : GESTION DE LA MODALE DE BIENVENUE
    // =======================================================================
    if (!sessionStorage.getItem('welcomeModalShown')) {
        const modalElement = document.getElementById('welcomeModal');
        if (modalElement) {
            const welcomeModal = new bootstrap.Modal(modalElement);
            welcomeModal.show();
            sessionStorage.setItem('welcomeModalShown', 'true');
        }
    }

    // =======================================================================
    // SECTION B : LOGIQUE DU CHAT
    // =======================================================================

    // --- 1. S√©lection des √©l√©ments HTML ---
    const chatMessages = document.getElementById('chat-messages');
    const optionsContainer = document.getElementById('options-container');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const mainHeader = document.getElementById('main-header');

    // --- 2. Gestion de l'√©tat de la conversation ---
    let conversationState = {
        lang: null,
        currentStep: 'start',
        collectedData: {},
        generated_text: "" // Ajout pour la coh√©rence
    };

    // --- 3. Fonctions de manipulation de l'interface ---
    function scrollToBottom() {
        setTimeout(() => {
            if (chatMessages) {
                chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }

    function addMessage(content, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        const contentElement = document.createElement('div');
        contentElement.classList.add('content');
        
        const isSpinner = typeof content === 'string' && content.trim().startsWith('<div class="loading-content">');

        if (isSpinner) {
            contentElement.innerHTML = content;
        } else {
            contentElement.innerHTML = marked.parse(content);
            try {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(contentElement, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }
            } catch (e) { console.warn("Erreur KaTeX:", e); }
        }
        messageElement.appendChild(contentElement);
        chatMessages.appendChild(messageElement);
        scrollToBottom();
    }

    function showOptions(options, is_text_input = false) {
        optionsContainer.innerHTML = '';
        chatInput.disabled = is_text_input ? false : (options && options.length > 0);
        if(is_text_input) chatInput.focus();

        if (options && options.length > 0) {
            options.forEach(optionText => {
                const button = document.createElement('button');
                button.classList.add('btn', 'option-button');
                button.textContent = optionText;
                button.addEventListener('click', handleOptionClick);
                optionsContainer.appendChild(button);
            });
        }
        scrollToBottom();
    }

    // --- 4. Logique de communication et t√©l√©chargement ---
    async function sendMessageToBackend(userMessage) {
        let indicatorElement = null;
        if (!userMessage.startsWith('internal_')) {
            const indicatorHtml = `<div class="message ai" id="typing-indicator-bubble"><div class="content typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatMessages.insertAdjacentHTML('beforeend', indicatorHtml);
            indicatorElement = document.getElementById('typing-indicator-bubble');
            scrollToBottom();
        }

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMessage, state: conversationState })
            });

            if (indicatorElement) indicatorElement.remove();

            if (!response.ok) {
                // Si on re√ßoit 401 ou autre, on affiche l'erreur ici.
                const errorData = await response.json().catch(() => ({}));
                console.error(`Erreur HTTP: ${response.status}`, errorData.error || "Pas de d√©tails");
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            conversationState = data.state;
            addMessage(data.response, 'ai');
            showOptions(data.options, data.is_text_input);

        } catch (error) {
            if (indicatorElement) indicatorElement.remove();
            const errorText = conversationState.lang === 'fr' 
                ? "D√©sol√©, une erreur de communication est survenue. Veuillez r√©essayer."
                : "Sorry, a communication error occurred. Please try again.";
            addMessage(errorText, 'ai');
            const restartOption = conversationState.lang === 'fr' ? "Recommencer" : "Restart";
            showOptions([restartOption]);
            console.error("Erreur API:", error);
        }
    }

    async function downloadPdf() {
        const markdown_text_to_send = conversationState.generated_text;
        if (!markdown_text_to_send) {
            addMessage("Erreur : Aucun contenu √† t√©l√©charger.", 'ai');
            return;
        }

        const loadingHtml = `<div class="loading-content"><div class="spinner"></div><span>Pr√©paration du PDF...</span></div>`;
        addMessage(loadingHtml, 'ai');
        const loadingMessageContent = chatMessages.lastElementChild.querySelector('.content');

        try {
            const response = await fetch('/api/generate-pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ markdown_text: markdown_text_to_send, state: conversationState })
            });
            const data = await response.json();

            if (!response.ok || !data.success) {
                sendMessageToBackend("internal_pdf_generation_failed");
                return;
            }
            
            window.location.href = `/api/download/${data.temp_filename}/${data.download_filename}`;
            const successText = conversationState.lang === 'fr' ? "Votre t√©l√©chargement a commenc√©." : "Your download has started.";
            loadingMessageContent.innerHTML = `<span>${successText}</span>`;
            setTimeout(() => sendMessageToBackend("internal_pdf_download_complete"), 1500);

        } catch (error) {
            sendMessageToBackend("internal_pdf_generation_failed");
            console.error("Erreur de t√©l√©chargement PDF:", error);
        }
    }

    // --- 5. Gestion des √©v√©nements utilisateur ---
    function handleOptionClick(event) {
        const userChoice = event.target.textContent;
        addMessage(userChoice, 'user');
        optionsContainer.innerHTML = '';
        if (userChoice.includes('PDF')) {
            downloadPdf();
        } else {
            sendMessageToBackend(userChoice);
        }
    }

    chatForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        addMessage(userMessage, 'user');
        chatInput.value = '';
        sendMessageToBackend(userMessage);
    });

    // --- 6. Initialisation du chat ---
    document.querySelectorAll('.option-button').forEach(button => {
        button.addEventListener('click', handleOptionClick);
    });
    chatInput.disabled = true;

    // =======================================================================
    // SECTION C : LOGIQUE DE L'HISTORIQUE ET AUTRES
    // =======================================================================
    async function loadHistory() {
        const container = document.getElementById('history-items-container');
        if (!container) return;
        try {
            const response = await fetch('/api/history');
            if (!response.ok) throw new Error('Failed to fetch history');
            const historyItems = await response.json();
            container.innerHTML = '';
            historyItems.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" class="history-item" data-id="${item.id}"><i class="bi bi-chat-left-text me-2"></i>${item.title}</a>`;
                li.firstChild.onclick = handleHistoryClick;
                container.appendChild(li);
            });
        } catch (error) {
            console.error("Erreur de chargement de l'historique:", error);
            container.innerHTML = '<li><span class="history-item text-danger">Erreur</span></li>';
        }
    }

    async function handleHistoryClick(event) {
        event.preventDefault();
        const generationId = event.currentTarget.dataset.id;
        try {
            const response = await fetch(`/api/history/${generationId}`);
            if (!response.ok) throw new Error('Failed to fetch generation');
            const data = await response.json();
            
            chatMessages.innerHTML = '';
            addMessage(data.content, 'ai');
            
            conversationState.generated_text = data.content;
            const flow_type = data.flow_type;
            const options = (flow_type === 'digital')
                ? ["Recommencer", " r√©g√©n√©rer", "T√©l√©charger en Pr√©sentation (PDF)"]
                : ["Recommencer", " r√©g√©n√©rer", "T√©l√©charger en PDF"];
            showOptions(options);

        } catch (error) {
            console.error("Erreur de chargement de la g√©n√©ration:", error);
            addMessage("Impossible de charger cette conversation.", 'ai');
        }
    }
    
    // On expose la fonction pour qu'elle soit appelable depuis le HTML (onclick)
    window.startNewChat = function() {
        window.location.href = '/app';
    }

    // Chargement initial
    loadHistory();
    scrollToBottom();
});
</script>
</body>
</html>
