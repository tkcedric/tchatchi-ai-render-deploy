<!DOCTYPE html>
<html lang="fr">
<head>
        <!-- Viewport optimis√© pour mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- Ic√¥nes pour iOS -->
    <link rel="apple-touch-icon" href="/static/img/favicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Theme color -->
    <meta name="theme-color" content="#0b57d0">
    <meta name="msapplication-TileColor" content="#0b57d0">
    <!-- ... (toute la partie <head> et <style> reste inchang√©e) ... -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TCHATCHI AI Pedagogical Assistant</title>
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PVE22CBKK7"></script>

    <!-- Ajoutez ces lignes apr√®s les autres CDN -->
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- MathJax pour les formules math√©matiques -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- ChemDoodle pour la chimie -->
    <script src="https://web.chemdoodle.com/install/chemdoodle.min.js"></script>
    <link rel="stylesheet" href="https://web.chemdoodle.com/install/chemdoodle.min.css">

    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Geogebra pour les math√©matiques -->
    <script src="https://www.geogebra.org/apps/deployggb.js"></script>


    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PVE22CBKK7');
    </script>
    <style>
        :root {
            --sidebar-bg: #f8f9fa; --chat-background: #ffffff; --main-bg: #f8f9fa; --input-bg: #f8f9fa;
            --user-bubble-bg: #e7f1ff; --user-bubble-text: #001d35; --ai-bubble-bg: #f1f3f4;
            --ai-bubble-text: #202124; --text-color-primary: #1f1f1f; --text-color-secondary: #444746;
            --border-color: #dee2e6;
        }
        html, body { 
            height: 100%; 
            max-height: 100%; /* Emp√™che le body de d√©passer la taille de l'√©cran */
            overflow: hidden; /* Pas de scroll sur la page principale */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            max-width: 100%;
            overflow-x: hidden;
        }

        body { 
            display: flex; 
            background-color: var(--main-bg); 
        }
        
        #sidebar { width: 280px; background-color: var(--sidebar-bg); padding: 1rem; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        #sidebar .btn-new-chat { background-color: #d3e3fd; color: #0b57d0; border: none; font-weight: 500;}
        #sidebar h5 { color: var(--text-color-secondary); margin-top: 1.5rem; font-size: 0.9rem; text-transform: uppercase; font-weight: 600; }
        #sidebar .history-list { flex-grow: 1; overflow-y: auto; }
        #sidebar .history-item { color: var(--text-color-secondary); text-decoration: none; padding: 0.5rem; display: block; border-radius: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #sidebar .history-item:hover { background-color: #e0e6ef; }
        #sidebar .ia-disclaimer { font-size: 0.75rem; color: var(--text-color-secondary); margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem; }

        #main-container { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; /* Utilise la hauteur compl√®te de la fen√™tre */
            max-height: 100vh; /* Emp√™che le conteneur de grandir au-del√† */
            max-width: 100vw; 
            overflow: hidden;
        }
        /* --- 1. L'en-t√™te principal --- */
                #main-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--main-bg);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: nowrap;
            /* NOUVELLE TRANSITION, PLUS PERFORMANTE */
            transition: transform 0.3s ease-in-out;
        }

                #main-header.header-hidden {
            /* Au lieu de changer la hauteur, on d√©place la barre vers le haut */
            transform: translateY(-100%);
            /* En passant la position √† 'absolute', on retire l'en-t√™te du flux
               de la page. La zone de chat en dessous va alors automatiquement
               monter et occuper l'espace lib√©r√©, cr√©ant l'effet plein √©cran. */
            position: absolute;
        }

       /* --- 2. Le conteneur du logo et du titre --- */
        .app-title-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1; /* Permet au conteneur de grandir/r√©tr√©cir */
            min-width: 0; /* Astuce cruciale pour permettre au texte de se r√©duire */
        }

        /* --- 3. Le titre de l'application (pour √©viter qu'il ne d√©borde) --- */
        .app-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color-primary);
            /* Emp√™che le titre de d√©border et de pousser le menu */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #main-header .app-icon { font-size: 1.5rem; color: #0b57d0; }
        #main-header .app-title { font-size: 1.1rem; font-weight: 500; color: var(--text-color-primary); }
/* NOUVELLE VERSION CORRIG√âE */
#chat-container {
    flex-grow: 1; /* Prend l'espace vertical disponible */
    display: flex;
    flex-direction: column;
    background-color: var(--chat-background);
    /* TR√àS IMPORTANT : On retire la hauteur fixe et on laisse flexbox g√©rer */
    overflow-y: hidden; /* Le conteneur ne scroll pas, c'est son enfant qui le fera */
    position: relative; /* N√©cessaire pour que le scroll interne fonctionne bien */
}

#chat-messages {
    flex-grow: 1; /* Prend l'espace disponible √† l'int√©rieur de #chat-container */
    padding: 1rem;
    overflow-y: auto; /* C'est LUI qui scroll, et personne d'autre */
    -webkit-overflow-scrolling: touch; /* Am√©liore le scroll sur iOS */
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
        .message { display: flex; margin-bottom: 0.5rem; }
        .message .content { padding: 0.5rem 1rem; border-radius: 8px; max-width: 80%; width: fit-content; line-height: 1.5; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message.ai { justify-content: flex-start; }
        .message.ai .content { background-color: var(--ai-bubble-bg); color: var(--ai-bubble-text); border-radius: 0 8px 8px 8px; }
        .message.ai .content::before { content: ''; position: absolute; top: 0; left: -10px; width: 0; height: 0; border-style: solid; border-width: 0 10px 10px 0; border-color: transparent var(--ai-bubble-bg) transparent transparent; }
        .message.user { justify-content: flex-end; }
        .message.user .content { background-color: var(--user-bubble-bg); color: var(--user-bubble-text); border-radius: 8px 0 8px 8px; }
        .message.user .content::after { content: ''; position: absolute; top: 0; right: -10px; width: 0; height: 0; border-style: solid; border-width: 0 0 10px 10px; border-color: transparent transparent transparent var(--user-bubble-bg); }
        #chat-input-area { padding: 1rem 1.5rem; background-color: var(--main-bg); border-top: 1px solid var(--border-color); position: sticky; bottom: 0; /* Add safe area for mobile notches */padding-bottom: calc(1rem + env(safe-area-inset-bottom)); z-index: 20;}
        #chat-input-area-content { max-width: 800px; margin: 0 auto; width: 100%; }
        /* NOUVEAU BLOC CORRIG√â */

        #options-container {
            padding: 0 0 1rem 0;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            /* --- AJOUTS IMPORTANTS --- */
            max-height: 250px; /* On limite la hauteur √† 250px (environ 4-5 lignes de boutons) */
            overflow-y: auto;  /* Affiche une barre de d√©filement verticale si le contenu d√©passe */
            padding-right: 8px; /* Ajoute un petit espace pour que la barre de d√©filement ne colle pas aux boutons */
        }
        .option-button { border: 1px solid #c9c9c9; background-color: #fff; color: #3c4043; font-weight: 500; }
        .option-button:hover { background-color: #f1f1f1; }
        #chat-form .input-group { background-color: #ffffff; border-radius: 25px; padding: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        #chat-input { background-color: transparent; border: none; box-shadow: none; }
        #chat-submit-btn { background-color: transparent; border: none; color: #5f6368; font-size: 1.5rem; }
        #main-footer { text-align: center; font-size: 0.8rem; color: #999; padding: 0.5rem; background-color: var(--main-bg); border-top: 1px solid var(--border-color);  position: relative; z-index: 10;}
        

        /*
        
        ==================================================
        STYLE POUR LE SPINNER DE CHARGEMENT
        ==================================================
        */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1); /* Bordure grise l√©g√®re */
            border-top-color: #0d6efd; /* Couleur bleue pour la partie qui tourne */
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite; /* Fait tourner l'animation */
        }

        /* L'animation de rotation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Conteneur pour aligner le spinner et le texte */
        .loading-content {
            display: flex;
            align-items: center;
            gap: 10px; /* Espace entre le spinner et le texte */
        }
        /* style pour la langue de la home page*/

        .lang-selector {
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            background-color: #e9ecef;
            border-radius: 25px;
            display: flex; /* Pour aligner les boutons de langue */
            align-items: center;
        }
        
        .lang-selector .lang-btn {
            text-decoration: none;
            color: #6c757d;
            padding: 0.2rem 0.4rem;
            border-radius: 20px;
        }

        .lang-selector .lang-btn.active {
            color: var(--primary-color);
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap; /* Allow buttons to wrap */
            justify-content: flex-end; /* Align to right */
        }


    /* ==================================================
       STYLE POUR L'INDICATEUR DE FRAPPE (PROGRESSION)
    ================================================== */
    .typing-indicator {
        display: flex;
        align-items: center;
        padding: 10px 15px !important; /* S'assure que le padding est correct */
    }

    /* Style pour chaque point de l'animation */
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background-color: #999; /* Couleur grise pour les points */
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        /* On lie chaque point √† l'animation */
        animation: bounce 1.4s infinite ease-in-out both;
    }

    /* On ajoute un l√©ger d√©calage √† chaque point pour un effet fluide */
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0s; }

    /* L'animation elle-m√™me qui fait "rebondir" les points */
    @keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1.0);
        }
    }  
    
/* ==================================================
   STYLE POUR LA FEN√äTRE MODALE D'INFORMATION
================================================== */
#welcomeModal .modal-header {
    background-color: var(--primary-color);
    color: white;
}
#welcomeModal .modal-header .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}
#welcomeModal .modal-title {
    font-weight: 600;
}
#welcomeModal h4, #welcomeModal h6 {
    color: var(--primary-color);
    font-weight: bold;
}
#welcomeModal code {
    background-color: #e9ecef;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    color: #d63384;
    font-weight: bold;
    display: inline-block;
    margin: 5px 0;
}
#welcomeModal .donation-methods {
    padding-left: 1rem;
    border-left: 3px solid #dee2e6;
}


    /* ===========================
       RESPONSIVE DESIGN
    ============================ */
    /* Mobile menu toggle */
#menu-toggle {
    display: none;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
}

/* --- 4. Le bouton Burger Menu (sur mobile) --- */

    @media (max-width: 1200px) {
        #sidebar {
            width: 260px;
        }
        
        .message .content {
            max-width: 75%;
        }
    }
    
    @media (max-width: 992px) {
        #sidebar {
            width: 240px;
        }
        
        #main-header .app-title {
            font-size: 1.1rem;
        }
        
        .message .content {
            max-width: 80%;
            padding: 0.75rem 1rem;
        }
    }
/* NOUVEAU BLOC UNIFI√â √Ä AJOUTER */

    @media (max-width: 768px) {
        /* --- Structure g√©n√©rale sur mobile --- */
        body {
            flex-direction: column;
            overflow: auto;
            height: auto;
        }
        
        #sidebar {
            width: 100%;
            height: auto;
            border-right: none;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem;
        }
        
        #main-container {
            height: auto;
            min-height: 100vh;
        }
        
        #main-header {
            padding: 0.5rem;
        }
        
        .message .content {
            max-width: 85%;
        }
        
        #chat-input-area {
            padding: 0.75rem;
        }
        
        #options-container {
            padding-bottom: 0.75rem;
        }
        
        .option-button {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        /* --- Bouton Burger (Menu Hamburger) --- */
        #menu-toggle {
            display: flex; /* S'assure qu'il est visible sur mobile */
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            flex-shrink: 0;
            margin-left: auto; /* Le pousse tout √† droite */
        }

        /* --- Styles pour le menu lat√©ral (mobile) --- */
        .nav-menu {
            position: fixed;
            top: 60px;
            right: -100%; /* Cach√© par d√©faut en dehors de l'√©cran */
            width: 220px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            flex-direction: column; /* Aligne les boutons verticalement */
            align-items: stretch;
            gap: 0.5rem;
            z-index: 1000;
            transition: right 0.3s ease-in-out;
            border: 1px solid var(--border-color);
        }
        
        .nav-menu.show {
            right: 1rem; /* Fait appara√Ætre le menu */
        }

        .nav-menu .btn {
            width: 100%;
            text-align: left;
        }

        .lang-selector {
        order: -1; /* Place le s√©lecteur de langue en haut du menu mobile */
        margin-bottom: 0.5rem; /* Ajoute un peu d'espace en dessous */
        }
    }

    @media (max-width: 576px) {
        #sidebar {
            position: fixed;
            z-index: 1000;
            height: 100%;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            padding: 0.5rem;
        }
        
        #sidebar.show {
            transform: translateX(0);
        }
        
        #main-container {
            margin-left: 0;
        }
        
        #menu-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--main-bg);
            border: 1px solid var(--border-color);
            margin-right: 0.5rem;
        }
        
        #chat-messages {
            padding: 1rem 0.75rem;
        }
        
        .message .content {
            max-width: 90%;
            padding: 0.6rem 0.9rem;
            font-size: 0.95rem;
        }
        
        #chat-input-area {
            padding: 0.75rem 0.75rem calc(0.75rem + env(safe-area-inset-bottom));
        }
        
        #chat-form .input-group {
            padding: 0.25rem;
            border-radius: 20px;
        }
        
        #chat-input {
            font-size: 0.95rem;
            padding: 0.5rem 0.75rem;
        }
        
        #chat-submit-btn {
            font-size: 1.25rem;
            padding: 0 0.75rem;
        }
        
        .option-button {
            font-size: 0.85rem;
            padding: 0.35rem 0.7rem;
            margin: 0.15rem;
        }
    }
    
    @media (max-width: 480px) {
        #main-header {
            flex-direction: column;
            align-items: flex-start;
            padding: 0.5rem 1rem;
        }
        #main-header .app-title {
            font-size: 0.9rem;
        }
        #chat-input-area {
            padding: 0.5rem 1rem;
        }
        #chat-input-area-content {
            max-width: 100%;
        }
        #options-container {
            flex-direction: column;
            gap: 0.25rem;
        }
        .option-button {
            width: 100%;
            text-align: center;
        }
    }
    .app-icon {
        width: 60px;  /* Correspond √† la taille de police de 1.5rem */
        height: 60px; /* Maintient le ratio carr√© */
        object-fit: contain; /* S'assure que l'image s'adapte sans √™tre d√©form√©e */
    }
    /* Menu mobile am√©lior√© */
.nav-menu-mobile {
    position: fixed;
    top: 0;
    right: -100%;
    width: 85%;
    max-width: 300px;
    height: 100%;
    background: white;
    box-shadow: -5px 0 15px rgba(0,0,0,0.15);
    padding: 1.5rem;
    transition: right 0.3s ease-in-out;
    z-index: 1040;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.nav-menu-mobile.show {
    right: 0;
}

.nav-link-mobile {
    padding: 1rem 0;
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--text-dark);
    text-decoration: none;
    border-bottom: 1px solid var(--bg-light);
    display: block;
}

/* Overlay pour le menu mobile */
.mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1039;
    display: none;
}

.mobile-menu-overlay.show {
    display: block;
}
/* ======================================================================= */
/* CORRECTIONS RESPONSIVES POUR LA PAGE DE CHAT */
/* ======================================================================= */

@media (max-width: 768px) {
    /* Structure principale */
    body {
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }
    
    #sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 85%;
        max-width: 280px;
        height: 100%;
        z-index: 1050;
        transition: left 0.3s ease-in-out;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    
    #sidebar.show {
        left: 0;
    }
    
    /* Overlay pour la sidebar mobile */
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1049;
        display: none;
    }
    
    .sidebar-overlay.show {
        display: block;
    }
    
    /* Header du chat */
    #main-header {
        padding: 0.5rem 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .app-title {
        font-size: 0.9rem;
    }
    
    /* Zone de chat */
    #chat-messages {
        padding: 1rem 0.75rem;
        margin-bottom: env(safe-area-inset-bottom, 0);
    }
    
    .message .content {
        max-width: 90%;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
    }
    
    /* Zone d'input */
    #chat-input-area {
        padding: 0.75rem;
        padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
    }
    
    #chat-input {
        font-size: 16px; /* Emp√™che le zoom sur iOS */
    }
    
    /* Options */
    #options-container {
        max-height: 200px;
        padding-bottom: 0.75rem;
    }
    
    .option-button {
        padding: 0.75rem 1rem;
        margin: 0.25rem;
        font-size: 0.9rem;
        min-height: 44px;
    }
    
    /* Boutons d'action */
    #menu-toggle, #chat-submit-btn {
        min-width: 44px;
        min-height: 44px;
    }
}

@media (max-width: 576px) {
    /* Tr√®s petits √©crans */
    #chat-messages {
        padding: 0.5rem;
    }
    
    .message .content {
        max-width: 95%;
        padding: 0.6rem 0.9rem;
    }
    
    #options-container {
        flex-direction: column;
    }
    
    .option-button {
        width: 100%;
        text-align: center;
    }
    
    /* Input group compact */
    #chat-form .input-group {
        padding: 0.25rem;
    }
    
    #chat-input {
        padding: 0.75rem;
    }
}


/* Styles pour l'√©diteur am√©lior√© */
.editor-container {
    margin-bottom: 1rem;
}

#markdown-preview {
    font-family: system-ui, -apple-system, sans-serif;
    line-height: 1.6;
}

#markdown-preview img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#markdown-preview pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 1rem;
    overflow-x: auto;
}

#markdown-preview code {
    background: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
}

#markdown-preview blockquote {
    border-left: 4px solid #0d6efd;
    padding-left: 1rem;
    margin-left: 0;
    color: #6c757d;
    font-style: italic;
}

/* Styles pour les diagrammes Mermaid */
.mermaid {
    text-align: center;
    margin: 1rem 0;
}

.mermaid svg {
    max-width: 100%;
    height: auto;
}

/* Styles pour l'√©diteur multidisciplinaire */
.modal-xxl {
    max-width: 95%;
}

#tools-sidebar {
    min-height: 60vh;
    max-height: 60vh;
    overflow-y: auto;
}

.tool-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tool-card:hover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.tool-card.active {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}

.tool-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

/* Styles pour les formules math√©matiques */
.math-preview {
    font-size: 1.2em;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Styles pour la chimie */
#chemdoodle-canvas {
    background-color: white;
}

.chem-element-btn {
    margin: 2px;
}

/* Styles pour les graphiques */
.chart-container {
    position: relative;
    height: 300px;
}

/* Styles pour l'aper√ßu enrichi */
#markdown-preview .math-formula {
    display: inline-block;
    margin: 0 0.2em;
    padding: 0.2em 0.4em;
    background: #f8f9fa;
    border-radius: 4px;
}

#markdown-preview .chemical-equation {
    font-family: 'Times New Roman', serif;
    font-size: 1.1em;
    padding: 0.5em;
    background: #fff3cd;
    border-radius: 4px;
    display: inline-block;
}

#markdown-preview .molecule-diagram {
    text-align: center;
    margin: 1em 0;
    padding: 1em;
    background: #f8f9fa;
    border-radius: 8px;
}

/* Responsive */
@media (max-width: 768px) {
    .modal-xxl {
        max-width: 100%;
        margin: 0.5rem;
    }
    
    #tools-sidebar {
        min-height: auto;
        max-height: 200px;
    }
}
    </style>
      
</head>
<body>

    <!-- ... (tout le HTML de la sidebar et du main-container reste inchang√©) ... -->
   <div id="sidebar">
    <!-- On utilise onclick pour appeler la fonction JS globale -->
    <button class="btn btn-new-chat w-100 text-start mb-3" onclick="startNewChat()">
        <i class="bi bi-plus-lg me-2"></i>
        <!-- On ajoute un <span> pour la traduction -->
        <span data-lang-en="New Chat" data-lang-fr="Nouveau Chat">New Chat</span>
    </button>
    
    <div class="history-list">
        <!-- Le titre est maintenant traduisible -->
        <h5 data-lang-en="History" data-lang-fr="Historique">History</h5>
        
        <!-- Ce conteneur sera rempli dynamiquement par la fonction loadHistory() -->
        <ul class="list-unstyled" id="history-items-container">
            <!-- La liste est vide au d√©but -->
        </ul>
    </div>
    
    <div class="ia-disclaimer" data-lang-en="AI models can make mistakes. Please check important information." data-lang-fr="Les mod√®les d'IA peuvent faire des erreurs. Veuillez v√©rifier les informations importantes.">
        AI models can make mistakes. Please check important information.
    </div>
</div>

    <div id="main-container">

    <!-- ======================================================================= -->
    <!-- NOUVEL EN-T√äTE DYNAMIQUE -->
    <!-- ======================================================================= -->
    <div id="main-header">
        <button id="menu-toggle" class="d-lg-none btn btn-sm btn-light">
            <i class="bi bi-list"></i>
        </button>
        <div class="app-title-container">
            <img src="/static/img/favicon.png" alt="TCHATCHI AI Logo" class="app-icon"> 
            <span id="app-title" class="app-title">TCHATCHI AI <br>Pedagogical Assistant</span>
        </div>
        
        <!-- Ce menu s'affichera pour l'utilisateur connect√© -->
        <div class="nav-menu">
              
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle me-2"></i>
                    <!-- On affiche le nom de l'utilisateur ici -->
                    {{ user.full_name }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li></li><a href="/about" class="dropdown-item"  data-lang-en="About" data-lang-fr="√Ä Propos">About</a></li>
                    <li></li><a href="/donate" class="dropdown-item" ><i class="bi bi-heart"></i> <span data-lang-en="Donate" data-lang-fr="Soutenir projet">Donate</span></a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/logout">
                        <i class="bi bi-box-arrow-right me-2"></i> Se D√©connecter
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
    <!-- ======================================================================= -->
    <!-- FIN DU NOUVEL EN-T√äTE -->
    <!-- ======================================================================= -->
        <div id="chat-container">
            <div id="chat-messages">
                <div class="message ai">
                    <div class="content">Hello! I am the TCHATCHI AI pedagogical assistant. </div>

                </div>
                <div class="message ai">
                    <div class="content">Please choose your language.</div>

                </div>
                 <div class="message ai">
                    <div class="content">Bonjour ! Je suis l'assistant p√©dagogique TCHATCHI AI.</div>
                </div>
                <div class="message ai">
                    <div class="content">Veuillez choisir votre langue.</div>
                </div>
            </div>
        </div>
        <div id="chat-input-area">
            <div id="chat-input-area-content">
                <div id="options-container">
                    <button class="btn option-button">üá¨üáß English</button>
                    <button class="btn option-button">üá´üá∑ Fran√ßais</button>
                </div>
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Make a choice or send a message..." autocomplete="off">
                        <button id="chat-submit-btn" type="submit" class="btn"><i class="bi bi-arrow-up-circle-fill"></i></button>
                    </div>
                </form>
            </div>
        </div>
        <footer id="main-footer">
           <p> ¬© 2025 TCHATCHI AI Project - All rights reserved.</p><br>
           <p>Powered by TKC@Co</p>
        </footer>
    </div>


<!-- ======================================================================= -->
<!-- D√âBUT DE LA FEN√äTRE MODALE D'INFORMATION -->
<!-- ======================================================================= -->
<div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="welcomeModalLabel">Bienvenue sur TCHATCHI AI !</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Version Fran√ßaise -->
                <div class="mb-4">
                    <h4>üá´üá∑ Bienvenu sur TCHATCHI AI! L‚ÄôIA au service des enseignants camerounais</h4>
                    <p>
                        <strong>TCHATCHI AI</strong> est une plateforme con√ßue pour accompagner les enseignants du Cameroun dans la pr√©paration de leurs contenus p√©dagogiques.
                    </p>
                    <p>
                        <strong>Fonctionnalit√©s :</strong> G√©n√©ration rapide de fiches de le√ßon, d‚Äôactivit√©s d‚Äôint√©gration et d‚Äô√©valuations conformes aux programmes francophone et anglophone.
                    </p>
                    <p>
                        <strong>Notre mission :</strong> Redonner du temps aux enseignants, am√©liorer la qualit√© de l‚Äôenseignement, et promouvoir une √©ducation √©quitable.
                    </p>
                    <hr>
                    <h6>üí° Projet personnel, sans financement externe</h6>
                    <p>
                        Chaque ressource g√©n√©r√©e co√ªte en moyenne <strong>15 FCFA</strong> en frais de calcul. Plus de <strong>19 000 ressources</strong> ont d√©j√† √©t√© g√©n√©r√©es, soit un co√ªt cumul√© d'environ <strong>285 000 FCFA</strong>, enti√®rement √† notre charge.
                    </p>
                    <p>Vu le taux de participations de la part des utilisateur qui √©tait presque nul par rapport aux d√©penses, nous avons du restructurer la plateforme pour une utilisation plus mod√©r√©e et avantageuse pour ceux qui participent</p>
                    <h6>üí∞ Comment contribuer / faire un don</h6>
                    <p>Chaque don, petit ou grand, aide √† couvrir les frais et √† assurer l'accessibilit√© de la plateforme.</p>
                    <div class="donation-methods">
                        <p><strong>‚úÖ MTN Mobile Money (MOMO)</strong><br>
                           <code>*126*14*680018753*MONTANT#</code><br>
                           <small>Nom du compte : SODIACAM SARL_POS 1208</small>
                        </p>
                        <p><strong>‚úÖ Orange Money (OM)</strong><br>
                           <code>#150*47*895595*MONTANT#</code><br>
                           <small>Nom du compte : Tala Kuate Cedric</small>
                        </p>
                    </div>
                    <p><em>Remplacez "MONTANT" par la somme de votre don.</em></p>
                    <hr>
                
                    
                </div>

                <!-- English Version -->
                <div class="pt-4 border-top">
                    <h4>üá¨üáß Welcome to TCHATCHI AI! Empowering Cameroonian Teachers with AI</h4>
                    <p>
                        <strong>TCHATCHI AI</strong> is a personal project with no external funding, built to help Cameroonian teachers create lesson plans and assessments aligned with local curricula.
                    </p>
                    <p>
                        Each resource generated costs about <strong>15 FCFA</strong> in AI processing fees. Over <strong>19,000 resources</strong> have been generate, meaning over <strong>285,000 FCFA</strong> have been invested so far, free for educators.
                    </p>
                    <p>Given the participation rate on the part of users which was almost zero compared to expenses, we had to restructure the platform for more moderate and advantageous use for those who participate</p>
                    <h6>üí∞ Donate via:</h6>
                     <div class="donation-methods">
                        <p><strong>‚úÖ MTN MOMO</strong><br>
                           <code>*126*14*680018753*AMOUNT#</code><br>
                           <small>Account Name: SODIACAM SARL_POS 1208</small>
                        </p>
                        <p><strong>‚úÖ Orange Money</strong><br>
                           <code>#150*47*895595*AMOUNT#</code><br>
                           <small>Account Name: Tala Kuate Cedric</small>
                        </p>
                    </div>
                    <p><em>Replace "AMOUNT" with your donation amount.</em></p>
                    <hr>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Compris / Understood</button>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================================= -->
<!-- FIN DE LA FEN√äTRE MODALE D'INFORMATION -->
<!-- ======================================================================= -->
 <!-- ======================================================================= -->
<!-- D√âBUT DE LA NOUVELLE FEN√äTRE MODALE D'√âDITION AM√âLIOR√âE -->
<!-- ======================================================================= -->
 <!-- ======================================================================= -->
<!-- FEN√äTRE MODALE D'√âDITION MULTIDISCIPLINAIRE COMPL√àTE -->
<!-- ======================================================================= -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xxl modal-dialog-centered modal-dialog-scrollable" style="max-width: 95%;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="bi bi-tools"></i> √âditeur Multidisciplinaire-TCHATCHI AI
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Barre d'outils principale -->
                <div class="bg-light border-bottom p-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex flex-wrap gap-2">
                            <!-- Outils g√©n√©raux -->
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="preview-toggle">
                                    <i class="bi bi-eye"></i> Aper√ßu
                                </button>
                            </div>
                            
                            <!-- Outils par discipline -->
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-calculator"></i> Math√©matiques
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-tool="math-formula">
                                        <i class="bi bi-square"></i> Formule LaTeX
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-tool="math-graph">
                                        <i class="bi bi-graph-up"></i> Traceur de fonctions
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-tool="math-geometry">
                                        <i class="bi bi-triangle"></i> G√©om√©trie
                                    </a></li>
                                </ul>
                            </div>
                            
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-danger dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-flask"></i> Chimie
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-tool="chem-molecule">
                                        <i class="bi bi-circle"></i> √âditeur de mol√©cules
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-tool="chem-reaction">
                                        <i class="bi bi-arrow-right"></i> √âquations chimiques
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-tool="chem-periodic">
                                        <i class="bi bi-grid-3x3"></i> Tableau p√©riodique
                                    </a></li>
                                </ul>
                            </div>
                            
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-diagram-3"></i> Sciences
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-tool="science-diagram">
                                        <i class="bi bi-diagram-3"></i> Diagrammes Mermaid
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-tool="science-chart">
                                        <i class="bi bi-bar-chart"></i> Graphiques
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-tool="science-circuit">
                                        <i class="bi bi-lightning"></i> Circuits √©lectriques
                                    </a></li>
                                </ul>
                            </div>
                            
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-image"></i> Multim√©dia
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-tool="media-image">
                                        <i class="bi bi-image"></i> Ins√©rer image
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-tool="media-table">
                                        <i class="bi bi-table"></i> Tableaux
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" data-tool="media-code">
                                        <i class="bi bi-code-slash"></i> Code
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="text-muted small">
                            <i class="bi bi-info-circle"></i> S√©lectionnez votre discipline
                        </div>
                    </div>
                </div>

                <!-- Conteneur principal avec sidebar -->
                <div class="row g-0" style="min-height: 60vh;">
                    <!-- Sidebar des outils -->
                    <div class="col-md-3 border-end bg-light" id="tools-sidebar">
                        <div class="p-3">
                            <h6 class="border-bottom pb-2">Outils disponibles</h6>
                            <div id="tools-list">
                                <!-- Les outils seront charg√©s dynamiquement ici -->
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-magic display-6"></i>
                                    <p class="mt-2 small">S√©lectionnez une discipline pour voir les outils</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zone d'√©dition principale -->
                    <div class="col-md-9">
                        <div class="p-3">
                            <ul class="nav nav-tabs" id="editorTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">
                                        <i class="bi bi-pencil"></i> √âditeur
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">
                                        <i class="bi bi-eye"></i> Aper√ßu
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="live-tab" data-bs-toggle="tab" data-bs-target="#live" type="button" role="tab">
                                        <i class="bi bi-play-circle"></i> Vue Live
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content border border-top-0 rounded-bottom">
                                <!-- Onglet √âditeur -->
                                <div class="tab-pane fade show active" id="edit" role="tabpanel">
                                    <textarea id="editor-textarea" class="form-control border-0" style="height: 50vh; font-family: 'Courier New', monospace; resize: none;"></textarea>
                                </div>
                                
                                <!-- Onglet Aper√ßu -->
                                <div class="tab-pane fade" id="preview" role="tabpanel">
                                    <div id="markdown-preview" style="height: 50vh; overflow-y: auto; padding: 1rem;"></div>
                                </div>
                                
                                <!-- Onglet Vue Live -->
                                <div class="tab-pane fade" id="live" role="tabpanel">
                                    <div id="live-preview" style="height: 50vh; overflow-y: auto; padding: 1rem;">
                                        <div class="text-center text-muted py-5">
                                            <i class="bi bi-arrow-repeat display-4"></i>
                                            <p class="mt-2">Vue live en temps r√©el</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
                <button type="button" class="btn btn-success" id="save-content-btn">
                    <i class="bi bi-check-circle"></i> Sauvegarder
                </button>
                <button type="button" class="btn btn-primary" id="save-and-download-btn">
                    <i class="bi bi-file-earmark-arrow-down-fill"></i> T√©l√©charger PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ======================================================================= -->
<!-- MODALES SP√âCIALIS√âES PAR DISCIPLINE -->
<!-- ======================================================================= -->

<!-- Modal Formules Math√©matiques -->
<div class="modal fade" id="mathFormulaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-square"></i> √âditeur de Formules Math√©matiques</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">√âditeur LaTeX :</label>
                        <textarea class="form-control" id="latex-editor" rows="6" placeholder="\frac{a}{b} = \sqrt{c}">\frac{a}{b} = \sqrt{c}</textarea>
                        <div class="mt-2">
                            <small class="text-muted">Exemples : </small>
                            <div class="btn-group btn-group-sm mt-1">
                                <button type="button" class="btn btn-outline-secondary" data-example="\frac{a}{b}">Fraction</button>
                                <button type="button" class="btn btn-outline-secondary" data-example="\sqrt{x}">Racine</button>
                                <button type="button" class="btn btn-outline-secondary" data-example="\int_{a}^{b} f(x)dx">Int√©grale</button>
                                <button type="button" class="btn btn-outline-secondary" data-example="\sum_{i=1}^{n} i">Somme</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Aper√ßu :</label>
                        <div id="latex-preview" class="border rounded p-3 bg-light text-center" style="min-height: 150px;">
                            <div class="text-muted">Aper√ßu de la formule</div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Options :</label>
                            <select class="form-select" id="latex-display">
                                <option value="inline">En ligne : \(...\)</option>
                                <option value="block">Bloc : \[...\]</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="insert-latex">Ins√©rer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Traceur de Fonctions -->
<div class="modal fade" id="mathGraphModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-graph-up"></i> Traceur de Fonctions Math√©matiques</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Fonction f(x) :</label>
                            <input type="text" class="form-control" id="function-input" placeholder="x^2 + 2*x + 1" value="x^2">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Intervalle x :</label>
                            <div class="row g-2">
                                <div class="col">
                                    <input type="number" class="form-control" id="x-min" placeholder="Min" value="-5">
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" id="x-max" placeholder="Max" value="5">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Couleur :</label>
                            <input type="color" class="form-control form-control-color" id="graph-color" value="#ff0000">
                        </div>
                        <button class="btn btn-primary w-100" id="plot-function">
                            <i class="bi bi-play-fill"></i> Tracer
                        </button>
                        <div class="mt-3">
                            <small class="text-muted">Syntaxe support√©e :</small>
                            <ul class="small">
                                <li><code>x^2</code> - Carr√©</li>
                                <li><code>sin(x)</code> - Sinus</li>
                                <li><code>sqrt(x)</code> - Racine</li>
                                <li><code>log(x)</code> - Logarithme</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <canvas id="function-canvas" width="600" height="400" style="border: 1px solid #ddd; border-radius: 8px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="insert-graph">Ins√©rer Graphique</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal √âditeur de Mol√©cules Chimiques -->
<div class="modal fade" id="chemMoleculeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-circle"></i> √âditeur de Structures Chimiques</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div id="chemdoodle-canvas" style="width: 100%; height: 400px; border: 1px solid #ddd;"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Outils :</label>
                            <div class="btn-group-vertical w-100">
                                <button type="button" class="btn btn-outline-primary" id="chem-carbon">Carbone (C)</button>
                                <button type="button" class="btn btn-outline-primary" id="chem-oxygen">Oxyg√®ne (O)</button>
                                <button type="button" class="btn btn-outline-primary" id="chem-hydrogen">Hydrog√®ne (H)</button>
                                <button type="button" class="btn btn-outline-primary" id="chem-nitrogen">Azote (N)</button>
                                <button type="button" class="btn btn-outline-secondary" id="chem-bond">Liaison</button>
                                <button type="button" class="btn btn-outline-danger" id="chem-clear">Effacer</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mod√®les pr√©d√©finis :</label>
                            <select class="form-select" id="chem-templates">
                                <option value="">S√©lectionner...</option>
                                <option value="water">Eau (H‚ÇÇO)</option>
                                <option value="methane">M√©thane (CH‚ÇÑ)</option>
                                <option value="ethanol">√âthanol (C‚ÇÇH‚ÇÖOH)</option>
                                <option value="benzene">Benz√®ne (C‚ÇÜH‚ÇÜ)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="insert-molecule">Ins√©rer Mol√©cule</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal √âquations Chimiques -->
<div class="modal fade" id="chemReactionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-arrow-right"></i> √âditeur d'√âquations Chimiques</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">R√©actifs :</label>
                    <input type="text" class="form-control" id="reactants-input" placeholder="2H‚ÇÇ + O‚ÇÇ">
                </div>
                <div class="mb-3">
                    <label class="form-label">Produits :</label>
                    <input type="text" class="form-control" id="products-input" placeholder="2H‚ÇÇO">
                </div>
                <div class="mb-3">
                    <label class="form-label">Conditions :</label>
                    <input type="text" class="form-control" id="conditions-input" placeholder="Œî, 400¬∞C">
                </div>
                <div class="border rounded p-3 bg-light text-center">
                    <span id="reactants-preview"></span> 
                    <span class="mx-2">‚Üí</span>
                    <span id="products-preview"></span>
                    <br>
                    <small id="conditions-preview" class="text-muted"></small>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Utilisez _ pour les indices : H_2, O_2</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="insert-reaction">Ins√©rer √âquation</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Graphiques Scientifiques -->
<div class="modal fade" id="scienceChartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-bar-chart"></i> Cr√©ateur de Graphiques</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Type de graphique :</label>
                            <select class="form-select" id="chart-type">
                                <option value="bar">Barres</option>
                                <option value="line">Ligne</option>
                                <option value="pie">Camembert</option>
                                <option value="scatter">Nuage de points</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Donn√©es (CSV) :</label>
                            <textarea class="form-control" id="chart-data" rows="6" placeholder="Mati√®re,Note
Maths,15
Physique,18
Chimie,12">Mati√®re,Note
Maths,15
Physique,18
Chimie,12</textarea>
                        </div>
                        <button class="btn btn-primary w-100" id="update-chart">
                            <i class="bi bi-arrow-clockwise"></i> Mettre √† jour
                        </button>
                    </div>
                    <div class="col-md-8">
                        <canvas id="science-chart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-info" id="insert-chart">Ins√©rer Graphique</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour les autres outils (image, diagramme, etc. - garder ceux existants) -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">√âditer la ressource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Barre d'outils d'√©dition -->
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                    <div>
                        <small class="text-muted">Utilisez la syntaxe Markdown pour formater votre texte</small>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="preview-toggle">
                            <i class="bi bi-eye"></i> Aper√ßu
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="insert-image-btn">
                            <i class="bi bi-image"></i> Image
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" id="insert-diagram-btn">
                            <i class="bi bi-diagram-3"></i> Diagramme
                        </button>
                    </div>
                </div>
                
                <!-- Conteneur principal avec onglets -->
                <div class="editor-container">
                    <ul class="nav nav-tabs" id="editorTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab">
                                <i class="bi bi-pencil"></i> √âditeur
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">
                                <i class="bi bi-eye"></i> Aper√ßu
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content border border-top-0 rounded-bottom p-3">
                        <!-- Onglet √âditeur -->
                        <div class="tab-pane fade show active" id="edit" role="tabpanel">
                            <textarea id="editor-textarea" class="form-control" style="height: 50vh; font-family: 'Courier New', monospace;"></textarea>
                        </div>
                        
                        <!-- Onglet Aper√ßu -->
                        <div class="tab-pane fade" id="preview" role="tabpanel">
                            <div id="markdown-preview" style="height: 50vh; overflow-y: auto; padding: 1rem;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Guide de syntaxe rapide -->
                <div class="mt-3 p-3 bg-light rounded">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> Syntaxe rapide :</h6>
                    <div class="row small text-muted">
                        <div class="col-md-4">
                            <strong>Images :</strong><br>
                            <code>![texte](url)</code>
                        </div>
                        <div class="col-md-4">
                            <strong>Diagrammes :</strong><br>
                            <code>```mermaid<br>graph TD<br>A --> B```</code>
                        </div>
                        <div class="col-md-4">
                            <strong>Formatage :</strong><br>
                            <code>**gras** *italique*</code>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="save-and-download-btn">
                    <i class="bi bi-file-earmark-arrow-down-fill"></i> Sauvegarder et T√©l√©charger en PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ins√©rer une image -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ins√©rer une image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="image-url" class="form-label">URL de l'image :</label>
                    <input type="url" class="form-control" id="image-url" placeholder="https://example.com/image.jpg">
                </div>
                <div class="mb-3">
                    <label for="image-alt" class="form-label">Texte alternatif :</label>
                    <input type="text" class="form-control" id="image-alt" placeholder="Description de l'image">
                </div>
                <div class="form-text">
                    <small>Assurez-vous que l'URL de l'image est accessible publiquement.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="insert-image-confirm">Ins√©rer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ins√©rer un diagramme -->
<div class="modal fade" id="diagramModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ins√©rer un diagramme Mermaid</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="diagram-code" class="form-label">Code Mermaid :</label>
                        <textarea class="form-control" id="diagram-code" rows="10" placeholder="graph TD&#10;    A[Start] --> B{Decision}&#10;    B -->|Yes| C[Action 1]&#10;    B -->|No| D[Action 2]"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Aper√ßu :</label>
                        <div id="diagram-preview" class="border rounded p-3 bg-light" style="min-height: 200px;">
                            <small class="text-muted">L'aper√ßu appara√Ætra ici...</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Exemples :</h6>
                    <div class="row small">
                        <div class="col-md-4">
                            <strong>Graphique :</strong><br>
                            <code>graph TD<br>A --> B</code>
                        </div>
                        <div class="col-md-4">
                            <strong>S√©quence :</strong><br>
                            <code>sequenceDiagram<br>A->>B: Hello</code>
                        </div>
                        <div class="col-md-4">
                            <strong>Classe :</strong><br>
                            <code>classDiagram<br>Class01 : method()</code>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="insert-diagram-confirm">Ins√©rer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ins√©rer un tableau -->
<div class="modal fade" id="tableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-table"></i> √âditeur de Tableaux</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Dimensions du tableau :</label>
                            <div class="row g-2">
                                <div class="col">
                                    <label class="form-label small">Lignes</label>
                                    <input type="number" class="form-control" id="table-rows" min="1" max="10" value="3">
                                </div>
                                <div class="col">
                                    <label class="form-label small">Colonnes</label>
                                    <input type="number" class="form-control" id="table-cols" min="1" max="8" value="3">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">En-t√™tes :</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="table-header" checked>
                                <label class="form-check-label" for="table-header">
                                    Premi√®re ligne comme en-t√™te
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="table-align" checked>
                                <label class="form-check-label" for="table-align">
                                    Alignement centr√©
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Mod√®les pr√©d√©finis :</label>
                            <select class="form-select" id="table-templates">
                                <option value="">Personnalis√©</option>
                                <option value="comparison">Tableau de comparaison</option>
                                <option value="data">Tableau de donn√©es</option>
                                <option value="schedule">Emploi du temps</option>
                                <option value="grades">Notes d'√©valuation</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Aper√ßu :</label>
                        <div id="table-preview" class="border rounded p-3 bg-light" style="min-height: 200px; max-height: 300px; overflow-y: auto;">
                            <small class="text-muted">L'aper√ßu du tableau appara√Ætra ici...</small>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary" id="update-table-preview">
                                <i class="bi bi-arrow-clockwise"></i> Actualiser l'aper√ßu
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- √âditeur de contenu du tableau (appara√Æt dynamiquement) -->
                <div id="table-content-editor" class="mt-3" style="display: none;">
                    <label class="form-label">Contenu du tableau :</label>
                    <div id="table-cells-container" class="border rounded p-3 bg-light">
                        <!-- Les champs de saisie seront g√©n√©r√©s ici dynamiquement -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" id="insert-table">Ins√©rer Tableau</button>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================================= -->
<!-- FIN DE LA NOUVELLE FEN√äTRE MODALE D'√âDITION AM√âLIOR√âE -->
<!-- ======================================================================= -->

<!-- ======================================================================= -->
<!-- D√âBUT DU BLOC DE SCRIPTS UNIQUE ET RESTRUCTUR√â -->
<!-- ======================================================================= -->

<!-- 1. Import des librairies externes -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<!-- 2. Notre script principal d'application -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // =======================================================================
    // SECTION A : GESTION DE LA MODALE DE BIENVENUE
    // =======================================================================
    if (!sessionStorage.getItem('welcomeModalShown')) {
        const modalElement = document.getElementById('welcomeModal');
        if (modalElement) {
            const welcomeModal = new bootstrap.Modal(modalElement);
            welcomeModal.show();
            sessionStorage.setItem('welcomeModalShown', 'true');
        }
    }

    // =======================================================================
    // SECTION B : LOGIQUE DU CHAT
    // =======================================================================

    // --- 1. S√©lection des √©l√©ments HTML ---
    const chatMessages = document.getElementById('chat-messages');
    const optionsContainer = document.getElementById('options-container');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const mainHeader = document.getElementById('main-header');

    // --- 2. Gestion de l'√©tat de la conversation ---
    let conversationState = {
        lang: null,
        currentStep: 'start',
        collectedData: {},
        generated_text: "" // Ajout pour la coh√©rence
    };

    // --- 3. Fonctions de manipulation de l'interface ---
    function scrollToBottom() {
        setTimeout(() => {
            if (chatMessages) {
                chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
            }
        }, 100);
    }

    function addMessage(content, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        const contentElement = document.createElement('div');
        contentElement.classList.add('content');
        
        const isSpinner = typeof content === 'string' && content.trim().startsWith('<div class="loading-content">');

        if (isSpinner) {
            contentElement.innerHTML = content;
        } else {
            contentElement.innerHTML = marked.parse(content);
            try {
                if (typeof renderMathInElement === 'function') {
                    renderMathInElement(contentElement, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }
            } catch (e) { console.warn("Erreur KaTeX:", e); }
        }
        messageElement.appendChild(contentElement);
        chatMessages.appendChild(messageElement);
        scrollToBottom();
    }

    function showOptions(options, is_text_input = false) {
        // 1. On vide le conteneur des options pr√©c√©dentes.
        optionsContainer.innerHTML = '';
        
        // 2. On g√®re l'√©tat du champ de saisie de texte.
        // S'il faut une saisie texte, on l'active.
        // Sinon, on le d√©sactive s'il y a des boutons d'option, pour guider l'utilisateur.
        if (is_text_input) {
            chatInput.disabled = false;
            chatInput.focus(); // Met le curseur directement dans le champ de saisie.
        } else {
            chatInput.disabled = options && options.length > 0;
        }

        // 3. On cr√©e et affiche les boutons d'option fournis par le backend.
        if (options && options.length > 0) {
            options.forEach(optionText => {
                const button = document.createElement('button');
                button.classList.add('btn', 'option-button');
                button.textContent = optionText;
                // On attache le gestionnaire de clic √† chaque bouton.
                button.addEventListener('click', handleOptionClick);
                optionsContainer.appendChild(button);
            });
        }
        
        // 4. NOUVEL AJOUT : Logique pour afficher le bouton "√âditer".
        // On v√©rifie si un document a √©t√© g√©n√©r√© (conversationState.generated_text existe).
        if (conversationState.generated_text) {
            // On s'assure qu'on est bien sur le menu final (celui qui propose le PDF)
            // pour ne pas afficher "√âditer" au mauvais moment.
            const isFinalMenu = options.some(opt => opt.includes('PDF'));
            
            if (isFinalMenu) {
                const editButton = document.createElement('button');
                editButton.classList.add('btn', 'btn-outline-secondary'); // Un style un peu diff√©rent pour le distinguer.
                editButton.innerHTML = '<i class="bi bi-pencil-square"></i> √âditer';
                
                // On d√©finit ce qui se passe quand on clique sur "√âditer".
                editButton.addEventListener('click', () => {
                    // On r√©cup√®re la zone de texte de notre fen√™tre modale.
                    const editorTextarea = document.getElementById('editor-textarea');
                    // On y place le contenu du document g√©n√©r√©.
                    editorTextarea.value = conversationState.generated_text;
                    
                    // On r√©cup√®re le bouton "Sauvegarder" de la modale pour lui passer des informations.
                    const saveBtn = document.getElementById('save-and-download-btn');
                    // On lui attache le 'flow_type' (lecon, digital...) pour savoir quel format PDF g√©n√©rer.
                    saveBtn.dataset.flowType = conversationState.collectedData.flow_type;
                    
                    // On cr√©e une instance de la modale Bootstrap et on l'affiche.
                    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                    editModal.show();
                });
                
                // On ajoute le bouton "√âditer" √† la liste des options.
                optionsContainer.appendChild(editButton);
            }
        }

        // 5. On s'assure que la vue du chat est scroll√©e vers le bas pour voir les nouvelles options.
        scrollToBottom();
    }

    // --- 4. Logique de communication et t√©l√©chargement ---
    async function sendMessageToBackend(userMessage) {
    let indicatorElement = null;
    if (!userMessage.startsWith('internal_')) {
        const indicatorHtml = `<div class="message ai" id="typing-indicator-bubble"><div class="content typing-indicator"><span></span><span></span><span></span></div></div>`;
        chatMessages.insertAdjacentHTML('beforeend', indicatorHtml);
        indicatorElement = document.getElementById('typing-indicator-bubble');
        scrollToBottom();
    }

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMessage, state: conversationState })
        });

        // CORRECTION : Toujours supprimer l'indicateur, m√™me en cas d'erreur
        if (indicatorElement) {
            indicatorElement.remove();
            indicatorElement = null;
        }

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error(`Erreur HTTP: ${response.status}`, errorData.error || "Pas de d√©tails");
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        conversationState = data.state;
        addMessage(data.response, 'ai');
        showOptions(data.options, data.is_text_input);

    } catch (error) {
        // CORRECTION : S'assurer que l'indicateur est supprim√© en cas d'erreur
        if (indicatorElement) {
            indicatorElement.remove();
            indicatorElement = null;
        }
        const errorText = conversationState.lang === 'fr' 
            ? "D√©sol√©, une erreur de communication est survenue. Veuillez r√©essayer."
            : "Sorry, a communication error occurred. Please try again.";
        addMessage(errorText, 'ai');
        const restartOption = conversationState.lang === 'fr' ? "Recommencer" : "Restart";
        showOptions([restartOption]);
        console.error("Erreur API:", error);
    }
}

    async function downloadPdf() {
        const markdown_text_to_send = conversationState.generated_text;
        if (!markdown_text_to_send) {
            addMessage("Erreur : Aucun contenu √† t√©l√©charger.", 'ai');
            return;
        }

        const loadingHtml = `<div class="loading-content"><div class="spinner"></div><span>Pr√©paration du PDF...</span></div>`;
        addMessage(loadingHtml, 'ai');
        const loadingMessageContent = chatMessages.lastElementChild.querySelector('.content');

        try {
            const response = await fetch('/api/generate-pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ markdown_text: markdown_text_to_send, state: conversationState })
            });
            const data = await response.json();

            if (!response.ok || !data.success) {
                sendMessageToBackend("internal_pdf_generation_failed");
                return;
            }
            
            window.location.href = `/api/download/${data.temp_filename}/${data.download_filename}`;
            const successText = conversationState.lang === 'fr' ? "Votre t√©l√©chargement a commenc√©." : "Your download has started.";
            loadingMessageContent.innerHTML = `<span>${successText}</span>`;
            setTimeout(() => sendMessageToBackend("internal_pdf_download_complete"), 1500);

        } catch (error) {
            sendMessageToBackend("internal_pdf_generation_failed");
            console.error("Erreur de t√©l√©chargement PDF:", error);
        }
    }

     // --- NOUVELLE FONCTION POUR G√âRER L'√âDITION ET LE T√âL√âCHARGEMENT ---
        document.getElementById('save-and-download-btn').addEventListener('click', async () => {
        const editorTextarea = document.getElementById('editor-textarea');
        const editedContent = editorTextarea.value; // On r√©cup√®re le texte modifi√©
        
        const saveBtn = document.getElementById('save-and-download-btn');
        const flowType = saveBtn.dataset.flowType; // On r√©cup√®re le type de document

        // On met √† jour l'√©tat de la conversation avec le nouveau contenu.
        // C'est crucial pour que la fonction de t√©l√©chargement ait la bonne info.
        conversationState.generated_text = editedContent;
        if (conversationState.collectedData) {
            conversationState.collectedData.flow_type = flowType;
        } else {
             conversationState.collectedData = { flow_type: flowType };
        }
        
        // On ferme la modale.
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        editModal.hide();

        // On appelle la fonction de t√©l√©chargement existante.
        // Elle utilisera automatiquement le 'generated_text' que nous venons de mettre √† jour.
        await downloadPdf();
    });

    // --- 5. Gestion des √©v√©nements utilisateur ---
    function handleOptionClick(event) {
        const userChoice = event.target.textContent;
        addMessage(userChoice, 'user');
        optionsContainer.innerHTML = '';
        if (userChoice.includes('PDF')) {
            downloadPdf();
        } else {
            sendMessageToBackend(userChoice);
        }
    }

    chatForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        addMessage(userMessage, 'user');
        chatInput.value = '';
        sendMessageToBackend(userMessage);
    });

    // --- 6. Initialisation du chat ---
    document.querySelectorAll('.option-button').forEach(button => {
        button.addEventListener('click', handleOptionClick);
    });
    chatInput.disabled = true;

    // =======================================================================
    // SECTION C : LOGIQUE DE L'HISTORIQUE ET AUTRES
    // =======================================================================
    async function loadHistory() {
    const container = document.getElementById('history-items-container');
    if (!container) return;
    
    try {
        const response = await fetch('/api/history');
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const historyItems = await response.json();
        container.innerHTML = '';
        
        if (historyItems.length === 0) {
            const noHistoryText = conversationState.lang === 'fr' 
                ? "Aucun historique" 
                : "No history";
            container.innerHTML = `<li><span class="history-item text-muted">${noHistoryText}</span></li>`;
            return;
        }
        
        historyItems.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<a href="#" class="history-item" data-id="${item.id}">
                <i class="bi bi-chat-left-text me-2"></i>${item.title || 'Sans titre'}
            </a>`;
            li.firstChild.onclick = handleHistoryClick;
            container.appendChild(li);
        });
        
    } catch (error) {
        console.error("Erreur de chargement de l'historique:", error);
        
        const errorText = conversationState.lang === 'fr' 
            ? "Erreur de chargement de l'historique" 
            : "Error loading history";
        
        container.innerHTML = `<li><span class="history-item text-danger">${errorText}</span></li>`;
    }
}


    
/* ================================================================
    FONCTION AFFICHE L'HISTORIQUE DANS LA FENETRE MODALE
================================================================*/

async function handleHistoryClick(event) {
    event.preventDefault();
    const generationId = event.currentTarget.dataset.id;
    console.log("Tentative de chargement de l'historique ID:", generationId);
      // Afficher un indicateur de chargement
    const loadingHtml = `<div class="loading-content"><div class="spinner"></div><span>Chargement...</span></div>`;
    addMessage(loadingHtml, 'ai');

    try {
        const response = await fetch(`/api/history/${generationId}`);
        console.log("R√©ponse API:", response.status, response.statusText);

        if (!response.ok) throw new Error('Failed to fetch generation');
        
        const data = await response.json();
        console.log("Donn√©es re√ßues:", data);
        
        // Mettre √† jour l'√©tat global
        conversationState.generated_text = data.content;
        if (!conversationState.collectedData) {
            conversationState.collectedData = {};
        }
        conversationState.collectedData.flow_type = data.flow_type;
        conversationState.lang = conversationState.lang || 'fr';

        // CORRECTION : Initialiser l'√©diteur AVANT d'ouvrir la modale
        if (typeof multidisciplinaryEditor !== 'undefined') {
            multidisciplinaryEditor.init();
            multidisciplinaryEditor.setContent(data.content);
            multidisciplinaryEditor.setFlowType(data.flow_type);
            
             // CORRECTION : Passer l'ID aux deux boutons de sauvegarde
        const saveBtn = document.getElementById('save-content-btn');
        const saveDownloadBtn = document.getElementById('save-and-download-btn');
        
        if (saveBtn) saveBtn.dataset.generationId = generationId;
        if (saveDownloadBtn) saveDownloadBtn.dataset.generationId = generationId;
            
            // Forcer la mise √† jour de l'aper√ßu
            setTimeout(() => {
                multidisciplinaryEditor.updatePreview();
            }, 100);
        }

        // Ouvrir la modale
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        
        // S'assurer que l'onglet √©diteur est actif
        const editTab = document.getElementById('edit-tab');
        if (editTab) {
            editTab.click();
        }
        
        editModal.show();

               // Supprimer l'indicateur de chargement en cas de succ√®s
        if (chatMessages.lastElementChild && chatMessages.lastElementChild.querySelector('.loading-content')) {
            chatMessages.lastElementChild.remove();
        }

    } catch (error) {
        console.error("Erreur compl√®te:", error);
        // Supprimer l'indicateur de chargement en cas d'erreur
        if (chatMessages.lastElementChild && chatMessages.lastElementChild.querySelector('.loading-content')) {
            chatMessages.lastElementChild.remove();
        }
        console.error("Erreur de chargement de la g√©n√©ration:", error);
        const errorMessage = conversationState.lang === 'fr' 
            ? "Impossible de charger cette conversation. L'historique peut √™tre temporairement indisponible."
            : "Unable to load this conversation. History may be temporarily unavailable.";
        addMessage(errorMessage, 'ai');
    }
}



    // On expose la fonction pour qu'elle soit appelable depuis le HTML (onclick)

    window.startNewChat = function() {
        window.location.href = '/app';
    }

    // Chargement initial
    loadHistory();
    scrollToBottom();
});
// Gestion am√©lior√©e du menu mobile
function initMobileMenu() {
    const menuToggle = document.getElementById('menu-toggle');
    const closeMenuBtn = document.getElementById('close-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileOverlay = document.getElementById('mobile-menu-overlay');
    
    if (menuToggle && mobileMenu) {
        // Cr√©er l'overlay s'il n'existe pas
        if (!mobileOverlay) {
            const overlay = document.createElement('div');
            overlay.id = 'mobile-menu-overlay';
            overlay.className = 'mobile-menu-overlay';
            document.body.appendChild(overlay);
            
            overlay.addEventListener('click', () => {
                mobileMenu.classList.remove('show');
                overlay.classList.remove('show');
            });
        }
        
        menuToggle.addEventListener('click', () => {
            mobileMenu.classList.add('show');
            document.getElementById('mobile-menu-overlay').classList.add('show');
            document.body.style.overflow = 'hidden'; // Emp√™che le scroll du body
        });
        
        if (closeMenuBtn) {
            closeMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.remove('show');
                document.getElementById('mobile-menu-overlay').classList.remove('show');
                document.body.style.overflow = ''; // R√©tablit le scroll
            });
        }
    }
}

// Gestion du clavier virtuel
function handleVirtualKeyboard() {
    const chatInput = document.getElementById('chat-input');
    const chatInputArea = document.getElementById('chat-input-area');
    
    if (chatInput && chatInputArea) {
        chatInput.addEventListener('focus', () => {
            // Ajuste la position quand le clavier s'ouvre
            setTimeout(() => {
                chatInputArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        });
    }
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', () => {
    initMobileMenu();
    handleVirtualKeyboard();
    
    // D√©tection des appareils tactiles
    if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
    }
});

// =======================================================================
// √âDITEUR MULTIDISCIPLINAIRE COMPLET
// =======================================================================

function initMultidisciplinaryEditor() {
    let easyMDE = null;
    let currentFlowType = '';
    let currentChart = null;
    let chemCanvas = null;

    // Outils par discipline
    const toolsByDiscipline = {
        mathematics: [
            {
                id: 'math-formula',
                name: 'Formules LaTeX',
                icon: 'bi-square',
                description: '√âditeur de formules math√©matiques',
                category: 'Math√©matiques'
            },
            {
                id: 'math-graph',
                name: 'Traceur de fonctions',
                icon: 'bi-graph-up',
                description: 'Tracer des fonctions math√©matiques',
                category: 'Math√©matiques'
            },
            {
                id: 'math-geometry',
                name: 'G√©om√©trie interactive',
                icon: 'bi-triangle',
                description: 'Figures g√©om√©triques',
                category: 'Math√©matiques'
            }
        ],
        chemistry: [
            {
                id: 'chem-molecule',
                name: '√âditeur de mol√©cules',
                icon: 'bi-circle',
                description: 'Structures chimiques',
                category: 'Chimie'
            },
            {
                id: 'chem-reaction',
                name: '√âquations chimiques',
                icon: 'bi-arrow-right',
                description: '√âditeur d\'√©quations',
                category: 'Chimie'
            },
            {
                id: 'chem-periodic',
                name: 'Tableau p√©riodique',
                icon: 'bi-grid-3x3',
                description: '√âl√©ments chimiques',
                category: 'Chimie'
            }
        ],
        science: [
            {
                id: 'science-diagram',
                name: 'Diagrammes Mermaid',
                icon: 'bi-diagram-3',
                description: 'Diagrammes scientifiques',
                category: 'Sciences'
            },
            {
                id: 'science-chart',
                name: 'Graphiques',
                icon: 'bi-bar-chart',
                description: 'Graphiques de donn√©es',
                category: 'Sciences'
            },
            {
                id: 'science-circuit',
                name: 'Circuits √©lectriques',
                icon: 'bi-lightning',
                description: 'Sch√©mas √©lectriques',
                category: 'Sciences'
            }
        ],
        media: [
            {
                id: 'media-image',
                name: 'Ins√©rer image',
                icon: 'bi-image',
                description: 'Images et photos',
                category: 'Multim√©dia'
            },
            {
                id: 'media-table',
                name: 'Tableaux',
                icon: 'bi-table',
                description: 'Tableaux de donn√©es',
                category: 'Multim√©dia'
            },
            {
                id: 'media-code',
                name: 'Code',
                icon: 'bi-code-slash',
                description: 'Blocs de code',
                category: 'Multim√©dia'
            }
        ]
    };

    // Initialiser l'√©diteur
    function initEditor() {
        if (easyMDE) {
            easyMDE.toTextArea();
            easyMDE = null;
        }
        
        easyMDE = new EasyMDE({
            element: document.getElementById('editor-textarea'),
            spellChecker: false,
            autosave: { enabled: false },
            toolbar: false, // On utilise notre propre toolbar
            status: false,
            minHeight: '50vh'
        });

        // Charger les outils math√©matiques par d√©faut
        loadTools('mathematics');
    }

    // Charger les outils d'une discipline
    function loadTools(discipline) {
        const toolsList = document.getElementById('tools-list');
        const tools = toolsByDiscipline[discipline] || [];
        
        toolsList.innerHTML = tools.map(tool => `
            <div class="tool-card" data-tool="${tool.id}">
                <div class="tool-icon text-primary">
                    <i class="${tool.icon}"></i>
                </div>
                <h6 class="mb-1">${tool.name}</h6>
                <p class="small text-muted mb-0">${tool.description}</p>
            </div>
        `).join('');

        // Ajouter les √©v√©nements
        document.querySelectorAll('.tool-card').forEach(card => {
            card.addEventListener('click', function() {
                const toolId = this.dataset.tool;
                openToolModal(toolId);
            });
        });
    }

    // Ouvrir la modale d'un outil sp√©cifique
    function openToolModal(toolId) {
        switch(toolId) {
            case 'math-formula':
                $('#mathFormulaModal').modal('show');
                updateLatexPreview();
                break;
            case 'math-graph':
                $('#mathGraphModal').modal('show');
                initFunctionPlotter();
                break;
            case 'chem-molecule':
                $('#chemMoleculeModal').modal('show');
                initChemDoodle();
                break;
            case 'chem-reaction':
                $('#chemReactionModal').modal('show');
                updateReactionPreview();
                break;
            case 'science-chart':
                $('#scienceChartModal').modal('show');
                initScienceChart();
                break;
            case 'media-image':
                $('#imageModal').modal('show');
                break;
            case 'science-diagram':
                $('#diagramModal').modal('show');
                break;
        }
    }

    // =======================================================================
    // OUTILS MATH√âMATIQUES
    // =======================================================================

    // Formules LaTeX
    function updateLatexPreview() {
        const latexCode = document.getElementById('latex-editor').value;
        const previewElement = document.getElementById('latex-preview');
        
        try {
            previewElement.innerHTML = `\\(${latexCode}\\)`;
            MathJax.typeset([previewElement]);
        } catch (error) {
            previewElement.innerHTML = '<span class="text-danger">Erreur dans la formule</span>';
        }
    }

    // Traceur de fonctions
    function initFunctionPlotter() {
        const canvas = document.getElementById('function-canvas');
        const ctx = canvas.getContext('2d');
        
        window.plotFunction = function() {
            const funcStr = document.getElementById('function-input').value;
            const xMin = parseFloat(document.getElementById('x-min').value);
            const xMax = parseFloat(document.getElementById('x-max').value);
            const color = document.getElementById('graph-color').value;
            
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dessiner les axes
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            
            // Axe X
            ctx.beginPath();
            ctx.moveTo(0, canvas.height/2);
            ctx.lineTo(canvas.width, canvas.height/2);
            ctx.stroke();
            
            // Axe Y
            ctx.beginPath();
            ctx.moveTo(canvas.width/2, 0);
            ctx.lineTo(canvas.width/2, canvas.height);
            ctx.stroke();
            
            // Tracer la fonction
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const scaleX = canvas.width / (xMax - xMin);
            const scaleY = canvas.height / 20; // √âchelle Y arbitraire
            
            for (let x = xMin; x <= xMax; x += 0.1) {
                try {
                    // √âvaluation simple de la fonction
                    const y = eval(funcStr.replace(/x/g, `(${x})`));
                    const canvasX = (x - xMin) * scaleX;
                    const canvasY = canvas.height/2 - y * scaleY;
                    
                    if (x === xMin) {
                        ctx.moveTo(canvasX, canvasY);
                    } else {
                        ctx.lineTo(canvasX, canvasY);
                    }
                } catch (e) {
                    console.error('Erreur fonction:', e);
                }
            }
            
            ctx.stroke();
        };
        
        // √âv√©nements
        document.getElementById('plot-function').addEventListener('click', plotFunction);
        document.getElementById('function-input').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') plotFunction();
        });
        
        // Tracer par d√©faut
        plotFunction();
    }

    // =======================================================================
    // OUTILS CHIMIE
    // =======================================================================

    function initChemDoodle() {
        if (typeof ChemDoodle !== 'undefined') {
            chemCanvas = new ChemDoodle.ViewerCanvas('chemdoodle-canvas', 400, 400);
            chemCanvas.styles.atoms_displayTerminalCarbonLabels_2D = true;
            
            // √âv√©nements des boutons
            document.getElementById('chem-carbon').addEventListener('click', () => addAtom('C'));
            document.getElementById('chem-oxygen').addEventListener('click', () => addAtom('O'));
            document.getElementById('chem-hydrogen').addEventListener('click', () => addAtom('H'));
            document.getElementById('chem-nitrogen').addEventListener('click', () => addAtom('N'));
            document.getElementById('chem-clear').addEventListener('click', clearCanvas);
            
            // Mod√®les pr√©d√©finis
            document.getElementById('chem-templates').addEventListener('change', function(e) {
                loadTemplate(e.target.value);
            });
        }
    }

    function addAtom(element) {
        if (chemCanvas) {
            const molecule = chemCanvas.getMolecule();
            const atom = new ChemDoodle.structures.Atom(element, 200, 200);
            molecule.addAtom(atom);
            chemCanvas.repaint();
        }
    }

    function clearCanvas() {
        if (chemCanvas) {
            chemCanvas.clear();
            chemCanvas.repaint();
        }
    }

    function loadTemplate(template) {
        if (!chemCanvas) return;
        
        clearCanvas();
        const molecule = chemCanvas.getMolecule();
        
        switch(template) {
            case 'water':
                // H-O-H
                const o = new ChemDoodle.structures.Atom('O', 200, 200);
                const h1 = new ChemDoodle.structures.Atom('H', 150, 200);
                const h2 = new ChemDoodle.structures.Atom('H', 250, 200);
                molecule.addAtom(o);
                molecule.addAtom(h1);
                molecule.addAtom(h2);
                break;
            case 'methane':
                // CH4 t√©tra√©drique
                const c = new ChemDoodle.structures.Atom('C', 200, 200);
                molecule.addAtom(c);
                // Simplifi√© - positions approximatives
                for (let i = 0; i < 4; i++) {
                    const angle = (i * 90) * Math.PI / 180;
                    const h = new ChemDoodle.structures.Atom('H', 
                        200 + 50 * Math.cos(angle), 
                        200 + 50 * Math.sin(angle)
                    );
                    molecule.addAtom(h);
                }
                break;
        }
        
        chemCanvas.repaint();
    }

    // √âquations chimiques
    function updateReactionPreview() {
        const reactants = document.getElementById('reactants-input').value;
        const products = document.getElementById('products-input').value;
        const conditions = document.getElementById('conditions-input').value;
        
        document.getElementById('reactants-preview').textContent = formatChemical(reactants);
        document.getElementById('products-preview').textContent = formatChemical(products);
        document.getElementById('conditions-preview').textContent = conditions;
    }

    function formatChemical(formula) {
        return formula.replace(/_(\d)/g, '<sub>$1</sub>');
    }

    // =======================================================================
    // OUTILS SCIENCES
    // =======================================================================

    function initScienceChart() {
        updateScienceChart();
        
        document.getElementById('update-chart').addEventListener('click', updateScienceChart);
        document.getElementById('chart-type').addEventListener('change', updateScienceChart);
    }

    function updateScienceChart() {
        const chartType = document.getElementById('chart-type').value;
        const dataText = document.getElementById('chart-data').value;
        
        const ctx = document.getElementById('science-chart').getContext('2d');
        
        if (currentChart) {
            currentChart.destroy();
        }
        
        // Parser les donn√©es CSV simples
        const lines = dataText.trim().split('\n');
        const headers = lines[0].split(',');
        const labels = [];
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            labels.push(values[0]);
            data.push(parseFloat(values[1]));
        }
        
        const chartData = {
            labels: labels,
            datasets: [{
                label: headers[1],
                data: data,
                backgroundColor: [
                    '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0',
                    '#9966ff', '#ff9f40', '#ff6384', '#c9cbcf'
                ],
                borderWidth: 1
            }]
        };
        
        const config = {
            type: chartType,
            data: chartData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        };
        
        currentChart = new Chart(ctx, config);
    }

    // =======================================================================
    // GESTION DU CONTENU
    // =======================================================================

    function insertContent(content) {
        if (easyMDE) {
            easyMDE.codemirror.replaceSelection(content + '\n\n');
        } else {
            const textarea = document.getElementById('editor-textarea');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + content + '\n\n' + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + content.length + 2;
            textarea.focus();
        }
    }

    function updatePreview() {
        const markdownContent = easyMDE ? easyMDE.value() : document.getElementById('editor-textarea').value;
        const previewElement = document.getElementById('markdown-preview');
        
        if (previewElement) {
            let htmlContent = marked.parse(markdownContent);
            
            // Traiter les diagrammes Mermaid
            htmlContent = htmlContent.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, 
                (match, diagramCode) => `<div class="mermaid">${diagramCode}</div>`
            );
            
            previewElement.innerHTML = htmlContent;
            
            // MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typeset([previewElement]);
            }
            
            // Mermaid
            if (typeof mermaid !== 'undefined') {
                mermaid.initialize({ startOnLoad: true, theme: 'default' });
                mermaid.init(undefined, previewElement.querySelectorAll('.mermaid'));
            }
        }
    }

    // =======================================================================
    // √âV√âNEMENTS ET INITIALISATION
    // =======================================================================

    function initEvents() {
        // Navigation par discipline
        document.querySelectorAll('.dropdown-menu a[data-tool]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const tool = this.dataset.tool;
                openToolModal(tool);
            });
        });

        // Boutons de discipline
        document.querySelectorAll('.dropdown-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                const discipline = this.textContent.trim().toLowerCase();
                if (discipline.includes('math')) loadTools('mathematics');
                else if (discipline.includes('chim')) loadTools('chemistry');
                else if (discipline.includes('science')) loadTools('science');
                else if (discipline.includes('m√©dia')) loadTools('media');
            });
        });

        // Formules LaTeX
        document.getElementById('latex-editor').addEventListener('input', updateLatexPreview);
        document.querySelectorAll('[data-example]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('latex-editor').value = this.dataset.example;
                updateLatexPreview();
            });
        });
        document.getElementById('insert-latex').addEventListener('click', function() {
            const latexCode = document.getElementById('latex-editor').value;
            const displayMode = document.getElementById('latex-display').value;
            const wrapper = displayMode === 'block' ? '\\[' + latexCode + '\\]' : '\\(' + latexCode + '\\)';
            insertContent(wrapper);
            $('#mathFormulaModal').modal('hide');
        });

        // Graphiques de fonctions
        document.getElementById('insert-graph').addEventListener('click', function() {
            const funcStr = document.getElementById('function-input').value;
            insertContent(`**Graphique de la fonction:** \\(f(x) = ${funcStr}\\)\n\n*[Graphique g√©n√©r√©]*`);
            $('#mathGraphModal').modal('hide');
        });

        // √âquations chimiques
        document.getElementById('reactants-input').addEventListener('input', updateReactionPreview);
        document.getElementById('products-input').addEventListener('input', updateReactionPreview);
        document.getElementById('conditions-input').addEventListener('input', updateReactionPreview);
        document.getElementById('insert-reaction').addEventListener('click', function() {
            const reactants = document.getElementById('reactants-input').value;
            const products = document.getElementById('products-input').value;
            const conditions = document.getElementById('conditions-input').value;
            const equation = `${formatChemical(reactants)} ‚Üí ${formatChemical(products)}`;
            let content = `**√âquation chimique:** ${equation}`;
            if (conditions) content += `\n\n*Conditions: ${conditions}*`;
            insertContent(content);
            $('#chemReactionModal').modal('hide');
        });

        // Graphiques scientifiques
        document.getElementById('insert-chart').addEventListener('click', function() {
            insertContent('*[Graphique ins√©r√© - les donn√©es seront incluses dans le PDF]*');
            $('#scienceChartModal').modal('hide');
        });

        // Aper√ßu
        document.getElementById('preview-toggle').addEventListener('click', function() {
            const previewTab = document.getElementById('preview-tab');
            if (previewTab.classList.contains('active')) {
                document.getElementById('edit-tab').click();
            } else {
                updatePreview();
                previewTab.click();
            }
        });

        // Onglet aper√ßu
        document.getElementById('preview-tab').addEventListener('click', function() {
            setTimeout(updatePreview, 100);
        });
    }

    // Initialiser l'√©diteur de tableaux
    initTableEditor();
    // Initialisation
    initEvents();

    return {
        init: initEditor,
        getContent: function() {
            return easyMDE ? easyMDE.value() : document.getElementById('editor-textarea').value;
        },
        setContent: function(content) {
            if (easyMDE) {
                easyMDE.value(content);
            } else {
                document.getElementById('editor-textarea').value = content;
            }
        },
        setFlowType: function(flowType) {
            currentFlowType = flowType;
        },
        getFlowType: function() {
            return currentFlowType;
        }
    };
}

// =======================================================================
// INT√âGRATION AVEC L'APPLICATION EXISTANTE
// =======================================================================

// Initialiser l'√©diteur multidisciplinaire
const multidisciplinaryEditor = initMultidisciplinaryEditor();

// Remplacer l'ancien gestionnaire d'√©dition
document.addEventListener('DOMContentLoaded', () => {
    // ... votre code existant ...
    
    // MODIFIER cette partie pour utiliser le nouvel √©diteur
    document.querySelectorAll('.option-button').forEach(button => {
        if (button.innerHTML.includes('√âditer') || button.textContent.includes('√âditer')) {
            button.addEventListener('click', () => {
                // Initialiser l'√©diteur multidisciplinaire
                multidisciplinaryEditor.init();
                multidisciplinaryEditor.setContent(conversationState.generated_text);
                multidisciplinaryEditor.setFlowType(conversationState.collectedData.flow_type);
                
                const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                editModal.show();
            });
        }
    });
    
    // MODIFIER le gestionnaire de sauvegarde
    document.getElementById('save-and-download-btn').addEventListener('click', async () => {
        const editedContent = multidisciplinaryEditor.getContent();
        const flowType = multidisciplinaryEditor.getFlowType();
        
        conversationState.generated_text = editedContent;
        if (conversationState.collectedData) {
            conversationState.collectedData.flow_type = flowType;
        } else {
            conversationState.collectedData = { flow_type: flowType };
        }
        
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        editModal.hide();
        
        await downloadPdf();
    });
    
    // Nouveau bouton de sauvegarde seule
    document.getElementById('save-content-btn').addEventListener('click', function() {
        const editedContent = multidisciplinaryEditor.getContent();
        conversationState.generated_text = editedContent;
        
        // Afficher un message de confirmation
        const toast = new bootstrap.Toast(document.createElement('div'));
        // ... code pour toast ...
        
        console.log('Contenu sauvegard√© (mais pas t√©l√©charg√©)');
    });
});

/*==============================================================
// Nouvelle fonction pour sauvegarder les modifications
================================================================*/
// Nouvelle fonction pour sauvegarder les modifications
async function saveEditedContent(content, flowType, generationId) {
    try {
        const response = await fetch('/api/history/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                generation_id: generationId,
                content: content,
                flow_type: flowType
            })
        });
        
        if (!response.ok) {
            throw new Error('Erreur lors de la sauvegarde');
        }
        
        return await response.json();
    } catch (error) {
        console.error("Erreur de sauvegarde:", error);
        throw error;
    }
}

// Modifiez le gestionnaire de sauvegarde existant
document.getElementById('save-content-btn').addEventListener('click', async function() {
    const editedContent = multidisciplinaryEditor.getContent();
    const flowType = multidisciplinaryEditor.getFlowType();
    
    // Mettre √† jour l'√©tat local
    conversationState.generated_text = editedContent;
    
    try {
        // CORRECTION : Sauvegarder aussi dans la base de donn√©es
        const generationId = this.dataset.generationId; // Vous devrez passer l'ID
        if (generationId) {
            await saveEditedContent(editedContent, flowType, generationId);
        }
        
        // Afficher un message de confirmation
        const toast = document.createElement('div');
        toast.className = 'alert alert-success alert-dismissible fade show';
        toast.innerHTML = `
            <strong>Succ√®s!</strong> Modifications sauvegard√©es.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.modal-footer').prepend(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
        
    } catch (error) {
        const toast = document.createElement('div');
        toast.className = 'alert alert-danger alert-dismissible fade show';
        toast.innerHTML = `
            <strong>Erreur!</strong> Impossible de sauvegarder les modifications.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.modal-footer').prepend(toast);
    }
});


// =======================================================================
// FONCTIONS POUR LA GESTION DES TABLEAUX
// =======================================================================

function initTableEditor() {
    // Ouvrir la modale tableau
    document.querySelectorAll('[data-tool="media-table"]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            $('#tableModal').modal('show');
            generateTablePreview();
        });
    });

    // √âv√©nements pour la modale tableau
    document.getElementById('table-rows').addEventListener('input', generateTablePreview);
    document.getElementById('table-cols').addEventListener('input', generateTablePreview);
    document.getElementById('table-header').addEventListener('change', generateTablePreview);
    document.getElementById('table-align').addEventListener('change', generateTablePreview);
    document.getElementById('table-templates').addEventListener('change', applyTableTemplate);
    document.getElementById('update-table-preview').addEventListener('click', generateTablePreview);
    document.getElementById('insert-table').addEventListener('click', insertTableIntoEditor);
}

function generateTablePreview() {
    const rows = parseInt(document.getElementById('table-rows').value);
    const cols = parseInt(document.getElementById('table-cols').value);
    const hasHeader = document.getElementById('table-header').checked;
    const isCentered = document.getElementById('table-align').checked;
    
    const previewElement = document.getElementById('table-preview');
    const contentEditor = document.getElementById('table-content-editor');
    const cellsContainer = document.getElementById('table-cells-container');
    
    // G√©n√©rer le markup Markdown du tableau
    let tableMarkdown = '';
    
    // En-t√™te du tableau
    if (hasHeader) {
        tableMarkdown += '|';
        for (let c = 0; c < cols; c++) {
            tableMarkdown += ` En-t√™te ${c+1} |`;
        }
        tableMarkdown += '\n|';
        
        // Ligne de s√©paration
        for (let c = 0; c < cols; c++) {
            tableMarkdown += isCentered ? ' :---: |' : ' --- |';
        }
        tableMarkdown += '\n';
    } else {
        // Ligne de s√©paration sans en-t√™te
        tableMarkdown += '|';
        for (let c = 0; c < cols; c++) {
            tableMarkdown += isCentered ? ' :---: |' : ' --- |';
        }
        tableMarkdown += '\n';
    }
    
    // Corps du tableau
    const startRow = hasHeader ? 0 : 1;
    for (let r = startRow; r < rows + startRow; r++) {
        tableMarkdown += '|';
        for (let c = 0; c < cols; c++) {
            tableMarkdown += ` Cellule ${r+1}-${c+1} |`;
        }
        tableMarkdown += '\n';
    }
    
    // Afficher l'aper√ßu
    previewElement.innerHTML = marked.parse(tableMarkdown);
    
    // G√©n√©rer les champs de saisie pour le contenu
    generateTableInputs(rows, cols, hasHeader);
    contentEditor.style.display = 'block';
}

function generateTableInputs(rows, cols, hasHeader) {
    const cellsContainer = document.getElementById('table-cells-container');
    cellsContainer.innerHTML = '';
    
    const totalRows = hasHeader ? rows + 1 : rows;
    
    for (let r = 0; r < totalRows; r++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'row g-2 mb-2';
        
        for (let c = 0; c < cols; c++) {
            const colDiv = document.createElement('div');
            colDiv.className = 'col';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control form-control-sm';
            input.placeholder = `L${r+1}C${c+1}`;
            input.dataset.row = r;
            input.dataset.col = c;
            
            // Pr√©-remplir avec des valeurs par d√©faut
            if (hasHeader && r === 0) {
                input.value = `En-t√™te ${c+1}`;
            } else {
                const actualRow = hasHeader ? r : r + 1;
                input.value = `Cellule ${actualRow}-${c+1}`;
            }
            
            colDiv.appendChild(input);
            rowDiv.appendChild(colDiv);
        }
        
        cellsContainer.appendChild(rowDiv);
    }
}

function applyTableTemplate() {
    const template = document.getElementById('table-templates').value;
    
    switch(template) {
        case 'comparison':
            document.getElementById('table-rows').value = 4;
            document.getElementById('table-cols').value = 3;
            document.getElementById('table-header').checked = true;
            break;
            
        case 'data':
            document.getElementById('table-rows').value = 5;
            document.getElementById('table-cols').value = 4;
            document.getElementById('table-header').checked = true;
            break;
            
        case 'schedule':
            document.getElementById('table-rows').value = 6;
            document.getElementById('table-cols').value = 6;
            document.getElementById('table-header').checked = true;
            break;
            
        case 'grades':
            document.getElementById('table-rows').value = 8;
            document.getElementById('table-cols').value = 5;
            document.getElementById('table-header').checked = true;
            break;
    }
    
    generateTablePreview();
}

function insertTableIntoEditor() {
    const rows = parseInt(document.getElementById('table-rows').value);
    const cols = parseInt(document.getElementById('table-cols').value);
    const hasHeader = document.getElementById('table-header').checked;
    const isCentered = document.getElementById('table-align').checked;
    
    // R√©cup√©rer les valeurs des cellules
    const inputs = document.querySelectorAll('#table-cells-container input');
    const cellValues = Array.from(inputs).map(input => input.value.trim() || input.placeholder);
    
    // G√©n√©rer le tableau Markdown final
    let tableMarkdown = '\n\n'; // Espace avant le tableau
    
    let cellIndex = 0;
    
    // En-t√™te
    if (hasHeader) {
        tableMarkdown += '|';
        for (let c = 0; c < cols; c++) {
            tableMarkdown += ` ${cellValues[cellIndex++]} |`;
        }
        tableMarkdown += '\n|';
        
        // Ligne de s√©paration
        for (let c = 0; c < cols; c++) {
            tableMarkdown += isCentered ? ' :---: |' : ' --- |';
        }
        tableMarkdown += '\n';
    } else {
        // Ligne de s√©paration sans en-t√™te
        tableMarkdown += '|';
        for (let c = 0; c < cols; c++) {
            tableMarkdown += isCentered ? ' :---: |' : ' --- |';
        }
        tableMarkdown += '\n';
    }
    
    // Corps du tableau
    const startRow = hasHeader ? 1 : 0;
    const totalRows = hasHeader ? rows + 1 : rows;
    
    for (let r = startRow; r < totalRows; r++) {
        tableMarkdown += '|';
        for (let c = 0; c < cols; c++) {
            if (cellIndex < cellValues.length) {
                tableMarkdown += ` ${cellValues[cellIndex++]} |`;
            }
        }
        tableMarkdown += '\n';
    }
    
    tableMarkdown += '\n'; // Espace apr√®s le tableau
    
    // Ins√©rer dans l'√©diteur
    if (typeof multidisciplinaryEditor !== 'undefined' && multidisciplinaryEditor.getContent) {
        const currentContent = multidisciplinaryEditor.getContent();
        multidisciplinaryEditor.setContent(currentContent + tableMarkdown);
    } else {
        const editorTextarea = document.getElementById('editor-textarea');
        if (editorTextarea) {
            editorTextarea.value += tableMarkdown;
        }
    }
    
    // Fermer la modale
    $('#tableModal').modal('hide');
    
    // Mettre √† jour l'aper√ßu si disponible
    if (typeof multidisciplinaryEditor !== 'undefined' && multidisciplinaryEditor.updatePreview) {
        multidisciplinaryEditor.updatePreview();
    }
}

// Fonction utilitaire pour ins√©rer un tableau simple rapidement
function insertQuickTable(rows = 3, cols = 3, hasHeader = true) {
    let tableMarkdown = '\n\n';
    
    // En-t√™te
    if (hasHeader) {
        tableMarkdown += '|';
        for (let c = 0; c < cols; c++) {
            tableMarkdown += ` Colonne ${c+1} |`;
        }
        tableMarkdown += '\n|';
        
        for (let c = 0; c < cols; c++) {
            tableMarkdown += ' --- |';
        }
        tableMarkdown += '\n';
    }
    
    // Donn√©es
    for (let r = 0; r < rows; r++) {
        tableMarkdown += '|';
        for (let c = 0; c < cols; c++) {
            tableMarkdown += ` Ligne ${r+1} Col ${c+1} |`;
        }
        tableMarkdown += '\n';
    }
    
    tableMarkdown += '\n';
    
    // Ins√©rer dans l'√©diteur
    if (typeof multidisciplinaryEditor !== 'undefined' && multidisciplinaryEditor.getContent) {
        const currentContent = multidisciplinaryEditor.getContent();
        multidisciplinaryEditor.setContent(currentContent + tableMarkdown);
    } else {
        const editorTextarea = document.getElementById('editor-textarea');
        if (editorTextarea) {
            editorTextarea.value += tableMarkdown;
        }
    }
}
</script>
</body>
</html>
